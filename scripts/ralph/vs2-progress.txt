# VETTR Backend - Score V2 Ralph Progress Log
Started: Sun Feb 15 16:02:08 EST 2026
---
## VS2-001: Create financial_data schema table
Status: ✅ COMPLETE
Date: 2026-02-15
Details:
- Created src/db/schema/financial-data.ts with 15 financial fields (cash, monthly_burn, total_debt, total_assets, exploration_exp, r_and_d_exp, total_opex, g_and_a_expense, revenue, shares_current, shares_1yr_ago, insider_shares, total_shares, avg_vol_30d, days_since_last_pr)
- Used uuid PK, stock_id FK with cascade delete and unique constraint
- All numeric fields are nullable to support partial data scenarios
- Added index on stock_id for efficient lookups
- Exported financialData from schema/index.ts barrel
- Build passes
- **Learnings for future iterations:**
  - bigint fields need { mode: 'number' } option to avoid BigInt type issues in TypeScript
  - Schema files follow consistent pattern: import from drizzle-orm/pg-core, import related tables, define table with indexes in callback
  - Always add .js extension to local imports (ESM requirement)
---
## VS2-002: Create financial data seed file
Status: ✅ COMPLETE
Date: 2026-02-15
Details:
- Created src/db/seed/financial-data.ts with seedFinancialData function
- Seeded all 25 stocks with realistic financial data based on sector and market cap
- Mining sector stocks (NXE, ARIS, LUN, FM, TKO, ERO, CS, MAG, FVI, AEM, ELD, BTO, NGD, IMG, MND, LUG, KRR, RIO, SBB, GPL, FR, AG) have exploration_exp populated
- Tech/financial services stocks (SII) have r_and_d_exp populated  
- Royalty/streaming companies (WPM, OR) have both exploration_exp and r_and_d_exp as null
- 3 stocks (FM, ELD, IMG) have null cash AND null monthly_burn for testing null P1 Financial Survival pillar handling
- All stocks have complete data for: revenue, total_opex, g_and_a_expense, total_debt, total_assets, shares_current, shares_1yr_ago, insider_shares, total_shares, avg_vol_30d, days_since_last_pr
- Profitable companies have negative monthly_burn values (LUN, ERO, CS, FVI, WPM, AEM, OR, SII, BTO, LUG, KRR, FR, AG)
- Pre-production/development stage companies have zero revenue (NXE, MAG, RIO, SBB)
- Registered seedFinancialData in src/db/seed/index.ts (called after executives seed)
- Uses upsert on stock_id for safe re-seeding
- Build passes
- **Learnings for future iterations:**
  - Financial data must be sector-realistic: mining companies need exploration_exp, tech companies need r_and_d_exp
  - Negative monthly_burn indicates profitability (cash generation)
  - Null cash/burn scenarios are important for testing null pillar weight redistribution
  - Used onConflictDoUpdate with stock_id unique constraint for safe re-seeding
  - Share dilution scenarios included (some stocks have significantly more shares_current vs shares_1yr_ago)
  - Insider ownership varies from 5% to 20% across stocks for realistic Shareholder Structure scoring
---
## VS2-003: Alter vetr_score_history schema for 4 pillars
Status: ✅ COMPLETE
Date: 2026-02-15
Details:
- Replaced 5 old pillar columns (pedigreeScore, filingVelocityScore, redFlagScore, growthScore, governanceScore) with 4 new pillar columns
- Removed bonusPoints and penaltyPoints columns
- Added 4 pillar score columns (integer, not null, default 0): financialSurvivalScore, operationalEfficiencyScore, shareholderStructureScore, marketSentimentScore
- Added 8 sub-score columns (integer, nullable): cashRunwayScore, solvencyScore, efficiencyScore, pedigreeSubScore, dilutionPenaltyScore, insiderAlignmentScore, liquidityScore, newsVelocityScore
- Added 4 weight columns (doublePrecision, nullable): p1Weight, p2Weight, p3Weight, p4Weight
- Updated ScoreHistoryEntry interface to match new schema structure
- Added TODO comments and temporary placeholder values in saveScoreToHistory and getScoreHistory functions (will be replaced in VS2-009 and VS2-011)
- Kept existing columns: id, stockTicker, overallScore, calculatedAt
- Kept existing indexes on stockTicker and calculatedAt
- Build passes successfully
- **Learnings for future iterations:**
  - When altering a schema table, all TypeScript interfaces and service functions that reference the old schema must be updated to prevent build errors
  - Added doublePrecision import to pg-core imports for weight columns
  - Temporary placeholder values allow the codebase to remain in a working state while the full 4-pillar calculation logic is implemented in later stories
  - TODO comments clearly mark areas that will be updated in future stories (VS2-009, VS2-011)
  - Schema migrations like this should be carefully coordinated with service layer updates to avoid breaking changes
---
## VS2-004: Implement P1 Financial Survival calculator
Status: ✅ COMPLETE
Date: 2026-02-15
Details:
- Implemented financialSurvivalScore() function in src/services/vetr-score.service.ts
- Returns { score, cashRunway, solvency } or null if all inputs are null
- Cash Runway sub-metric (60% weight): handles profitable companies (monthly_burn <= 0 → score 100), zero cash (cash === 0 → score 0), and normal calculation (months = cash / monthly_burn, normalized to 18 months = 100)
- Solvency sub-metric (40% weight): handles zero assets (→ score 0), zero debt (→ score 100), and normal calculation (ratio = total_debt / total_assets, score = max(0, 100 - ratio * 200))
- Final score combines both sub-metrics with weights (60% cash runway, 40% solvency)
- Handles partial data scenarios: if only one sub-metric is available, uses that metric alone
- Returns null if ALL inputs are null, enabling null pillar weight redistribution in later stories
- Build passes successfully
- **Learnings for future iterations:**
  - The Financial Survival pillar is crucial for early-stage companies with limited cash runway
  - Profitable companies (negative monthly_burn) get full 100 score for cash runway to reward cash generation
  - Null pillar handling allows flexible scoring when financial data is incomplete
  - Used Math.min() and Math.max() to clamp scores to 0-100 range
  - Separated sub-metric calculation logic for clarity and maintainability
---
## VS2-005: Implement P2 Operational Efficiency calculator
Status: ✅ COMPLETE
Date: 2026-02-15
Details:
- Implemented operationalEfficiencyScore() function in src/services/vetr-score.service.ts
- Returns { score, efficiencyRatio } or null if all inputs are null
- Sector-specific formulas:
  - Mining sector (contains 'Mining', 'Gold', 'Resource'): ratio = exploration_exp / total_opex
  - Tech sector (contains 'Tech', 'Software'): ratio = r_and_d_exp / total_opex
  - General/all other sectors: ratio = (revenue - g_and_a_expense) / revenue
- Edge case handling:
  - If total_opex === 0 → score 50 (neutral score for no operating expenses)
  - If revenue === 0 for general sector → score 0 (no revenue, no efficiency)
  - If ratio > 1 → score 100 (capped at maximum)
- Normalization: score = min(100, ratio / 0.70 * 100) where target ratio 0.70 = 100 score
- Returns null if all required inputs for the sector are null, enabling null pillar weight redistribution
- Build passes successfully
- **Learnings for future iterations:**
  - Sector-specific logic requires case-insensitive string matching on sector names
  - Different sectors optimize for different metrics (mining=exploration, tech=R&D, general=gross margin)
  - Edge cases like zero opex or zero revenue need specific handling to avoid division by zero
  - Null pillar handling allows flexible scoring when sector-specific data is incomplete
  - The 0.70 normalization target represents a 70% efficiency ratio as "excellent" (100 score)
  - Separated edge case checks before main ratio calculation for code clarity
---
## VS2-006: Implement P3 Shareholder Structure calculator
Status: ✅ COMPLETE
Date: 2026-02-15
Details:
- Implemented shareholderStructureScore() function in src/services/vetr-score.service.ts
- Returns { score, pedigree, dilution, insider } or null if all inputs are null
- Pedigree sub-metric (50% weight):
  - E (Experience): Average years (yearsAtCompany + previousCompanies * 3) * 5, max 100
  - C (Career Diversity): Count unique previous companies across all executives * 10, max 100
  - A (Academic): Education field mapping using keyword matching (PhD=100, MBA=90, Master=85, etc.)
  - M (Market Alignment): Default 50 (no market alignment data available)
  - PG = E×0.40 + C×0.25 + A×0.20 + M×0.15
  - If no executives → default score 50
- Dilution Penalty sub-metric (30% weight):
  - dilution_pct = (shares_current - shares_1yr_ago) / shares_1yr_ago
  - If shares_1yr_ago null → score 100 (benefit of the doubt)
  - If dilution < 0 (buyback) → score 100
  - score = max(0, 100 - dilution_pct * 200) where 50% dilution = 0 score
- Insider Alignment sub-metric (20% weight):
  - ownership_pct = insider_shares / total_shares
  - score = min(100, ownership_pct / 0.20 * 100) where 20% ownership = 100 score
  - If data null → default score 50
- Final score combines all sub-metrics: P3 = pedigree * 0.50 + dilution * 0.30 + insider * 0.20
- Handles null pillar scenario: returns null if all inputs are null (no executives and no share data)
- Build passes successfully
- **Learnings for future iterations:**
  - Pedigree calculation uses the same executive data structure as the old pedigreeScore function but with a new formula
  - Career diversity now counts unique previous companies across ALL executives (not per executive)
  - Education mapping uses keyword matching for common designations (P.Eng, P.Geo, CPA, CFA, MBA, PhD, etc.)
  - Share dilution is a critical metric for early-stage companies with frequent financings
  - Buyback scenarios (negative dilution) get full score to reward shareholder-friendly capital allocation
  - Insider ownership target of 20% = 100 score aligns with good corporate governance practices
  - The default scores (50 for missing data) provide a neutral baseline when data is unavailable
  - Sub-metric weights (50% pedigree, 30% dilution, 20% insider) reflect relative importance of each factor
---
## VS2-007: Implement P4 Market Sentiment calculator
Status: ✅ COMPLETE
Date: 2026-02-15
Details:
- Implemented marketSentimentScore() function in src/services/vetr-score.service.ts
- Returns { score, liquidity, newsVelocity } or null if all inputs are null
- Liquidity Health sub-metric (60% weight): dailyVolValue = avg_vol_30d * price; score = min(100, dailyVolValue / 100000 * 100) where target $100k = 100 score
- News Velocity sub-metric (40% weight): uses days_since_last_pr if available, otherwise computes from filingList (days since most recent filing), defaults to 90 days if both null
- News Velocity scoring: days < 14 → score 100; days > 60 → score 0; linear decay in between: score = max(0, 100 - ((days - 14) * 100) / 46)
- Final score combines both sub-metrics with weights (60% liquidity, 40% news velocity)
- Handles partial data scenarios: if only one sub-metric is available, uses that metric alone
- Returns null if ALL inputs are null, enabling null pillar weight redistribution in later stories
- Build passes successfully
- **Learnings for future iterations:**
  - Market Sentiment pillar captures both liquidity (trading activity) and market engagement (news/filings)
  - Liquidity score uses dollar volume (shares × price) rather than just share volume to reflect actual capital flow
  - News Velocity uses a 14-60 day window: 14 days = fresh/engaged, 60+ days = stale/inactive
  - Linear decay formula for News Velocity: (100 - ((days - 14) * 100) / 46) creates smooth transition from 100 to 0
  - Fallback from days_since_last_pr to filingList provides robustness when PR-specific data isn't available
  - Default 90 days for news velocity when both inputs are null ensures a low (0) score for companies with no data
  - The P4 pillar has the lowest weight (15%) reflecting that market sentiment is less fundamental than financial/operational metrics
---
## VS2-008: Implement null pillar weight redistribution
Status: ✅ COMPLETE
Date: 2026-02-15
Details:
- Implemented redistributeWeights() function in src/services/vetr-score.service.ts
- Returns { adjustedWeights: Record<string, number>, nullPillars: string[] }
- Handles three scenarios:
  1. All pillars present: weights unchanged (0.35, 0.25, 0.25, 0.15)
  2. One or more pillars null: their weight distributed proportionally to remaining pillars (baseWeight / totalAvailable)
  3. All pillars null: overall score = 0, all weights = 0
- Example: if P2 (0.25) is null, totalAvailable = 0.75:
  - newP1 = 0.35 / 0.75 = 0.4667
  - newP3 = 0.25 / 0.75 = 0.3333
  - newP4 = 0.15 / 0.75 = 0.2000
- nullPillars array lists the string names of skipped pillars
- Build passes successfully
- **Learnings for future iterations:**
  - Weight redistribution ensures that the overall score calculation remains valid when some pillars have incomplete data
  - The function takes a generic array of pillar results with pillar name, score (or null), and base weight
  - Proportional redistribution maintains the relative importance of remaining pillars
  - Setting all weights to 0 when all pillars are null prevents division by zero in the overall score calculation
  - This function will be used in VS2-009 to rewrite calculateVetrScore with the 4-pillar formula
  - Clear documentation in the function comment helps explain the redistribution logic with concrete examples
---
## VS2-009: Rewrite calculateVetrScore with 4-pillar formula
Status: ✅ COMPLETE
Date: 2026-02-15
Details:
- Completely rewrote calculateVetrScore() function to use the 4-pillar VETR Score V2 system
- Added getFinancialDataForTicker() helper function to fetch financial_data rows
- calculateVetrScore() now fetches financial_data, executives, and filings in parallel
- Calls all 4 pillar calculators: financialSurvivalScore, operationalEfficiencyScore, shareholderStructureScore, marketSentimentScore
- Applies redistributeWeights() to handle null pillar weight redistribution
- Computes weighted overall score: sum of (pillarScore * adjustedWeight) for non-null pillars
- Result clamped to 0-100 integer
- Removed bonus_points and penalty_points from calculation
- Cached in Redis with vetr_score:{TICKER} key and 24h TTL (unchanged)
- Updated saveScoreToHistory() to save all new pillar scores, sub-scores, and weights to vetr_score_history table
- Updates stocks.vetr_score with new overall score after calculation
- Updated VetrScoreResult interface to match new 4-pillar structure with nested components, sub_scores, and null_pillars array
- Removed OLD 5-pillar component functions: pedigreeScore, filingVelocityScore, redFlagComponent, growthMetricsScore, governanceScore
- Removed OLD bonus/penalty functions: detectBonuses, detectPenalties
- Updated marketSentimentScore() signature to accept nullable price (stock.price can be null)
- Fixed admin.routes.ts to use null_pillars instead of bonus_points/penalty_points
- Build passes successfully
- **Learnings for future iterations:**
  - When rewriting a core calculation function, ensure all dependent code (routes, types) is also updated
  - The VetrScoreResult interface changed significantly - nested structure with components.{pillar}.score/weight/sub_scores
  - Null handling is critical - marketSentimentScore needed to accept nullable price, and db updates needed null checks
  - The new 4-pillar system is much cleaner and more maintainable than the old 5-pillar + bonuses/penalties approach
  - All pillar calculators (P1-P4) and redistributeWeights() are now integrated into the main calculation pipeline
  - The efficiencyScore stored in DB is the ratio converted to 0-100 score (ratio * 100)
  - Admin recalculate endpoint now returns the new format with null_pillars instead of bonus/penalty points
---
## VS2-010: Update VetrScoreResult type and API response format
Status: ✅ COMPLETE
Date: 2026-02-15
Details:
- VetrScoreResult interface was already updated in VS2-009 with new 4-pillar structure
- Interface now includes: ticker, overall_score, components (with all 4 pillars), null_pillars array, calculated_at
- Each pillar component has: score, weight, sub_scores object
- Financial Survival sub-scores: cash_runway, solvency
- Operational Efficiency sub-scores: efficiency_ratio
- Shareholder Structure sub-scores: pedigree, dilution_penalty, insider_alignment
- Market Sentiment sub-scores: liquidity, news_velocity
- Removed top-level fields: weights, bonus_points, penalty_points
- GET /stocks/:ticker/vetr-score route handler already returns new format via calculateVetrScore()
- Build passes successfully
- **Learnings for future iterations:**
  - VS2-010 acceptance criteria were already satisfied by VS2-009 implementation
  - When implementing a large refactor (VS2-009), related type/API updates (VS2-010) are naturally completed together
  - The calculateVetrScore() function returns VetrScoreResult which is directly serialized to JSON by Hono
  - No additional route handler changes needed - the service layer update automatically updated the API response
  - The new nested components structure provides a clean, hierarchical view of score breakdown for clients
  - Each pillar's weight is stored alongside its score, allowing clients to understand the score composition
  - null_pillars array allows clients to know which pillars were skipped due to missing data
---
## VS2-011: Update score history retrieval for new schema
Status: ✅ COMPLETE
Date: 2026-02-15
Details:
- Reviewed getScoreHistory() function in src/services/vetr-score.service.ts
- Function already queries and returns new 4-pillar columns: financialSurvivalScore, operationalEfficiencyScore, shareholderStructureScore, marketSentimentScore
- Removed TODO comment from VS2-003 that was no longer needed
- Each history entry returns: id, stock_ticker, overall_score, financial_survival_score, operational_efficiency_score, shareholder_structure_score, market_sentiment_score, calculated_at
- GET /stocks/:ticker/vetr-score/history route handler already returns updated format via getScoreHistory()
- Build passes successfully
- **Learnings for future iterations:**
  - This story was mostly complete from VS2-003 when the schema was updated
  - The getScoreHistory() function correctly maps the new DB columns to snake_case JSON fields
  - The route handler requires no changes - it simply calls the service function and wraps the result
  - The schema already includes sub-score columns (cashRunwayScore, solvencyScore, etc.) but they're not included in history entries per the AC
  - History entries focus on the 4 main pillar scores, not the detailed sub-scores, for a cleaner API response
  - Removed the TODO comment to indicate the function is complete and up-to-date with V2 schema
---
## VS2-012: Update score trend for new schema
Status: ✅ COMPLETE
Date: 2026-02-15
Details:
- Reviewed getScoreTrend() function in src/services/vetr-score.service.ts
- Function already correctly uses overall_score for 30d/90d change calculation (lines 1048, 1054)
- No problematic references to old column names found in the function itself
- Found and fixed admin.routes.ts line 184: updated sortableColumns array from old pillar names (pedigreeScore, filingVelocityScore, redFlagScore, growthScore, governanceScore) to new pillar names (financialSurvivalScore, operationalEfficiencyScore, shareholderStructureScore, marketSentimentScore)
- GET /stocks/:ticker/vetr-score/trend route handler at src/routes/vetr-score.routes.ts:36-42 is already correct
- Build passes successfully
- **Learnings for future iterations:**
  - The getScoreTrend function was already compatible with the new schema since it only uses overallScore and calculatedAt columns
  - Admin CRUD routes with sortableColumns arrays need to be updated when schema column names change
  - Comments and local variable names (like pedigreeScore in shareholderStructureScore function) are fine - only DB column references need updating
  - VS2-012 was a minimal change story as expected - the trend calculation logic is schema-agnostic and only uses the overall_score field
  - Always grep for old column names across the entire codebase to catch all references, not just in service functions
---
## VS2-013: Update score comparison for new schema
Status: ✅ COMPLETE
Date: 2026-02-15
Details:
- Reviewed getScoreComparison() function in src/services/vetr-score.service.ts (lines 1116-1197)
- Function already correctly uses overall_score for sector ranking - no changes needed
- No references to old column names (pedigreeScore, filingVelocityScore, redFlagScore, growthScore, governanceScore) found in the function
- Verified GET /stocks/:ticker/vetr-score/compare route handler (lines 45-51 in vetr-score.routes.ts) - already correct
- Comprehensive search confirmed only valid references exist: comments documenting removed functions and local variable pedigreeScore in shareholderStructureScore()
- Build passes successfully
- No code changes required - this was a verification story
- **Learnings for future iterations:**
  - VS2-013 was already satisfied by previous implementations (VS2-009, VS2-012)
  - The getScoreComparison() function is schema-agnostic since it only uses overall_score for peer ranking
  - Sector comparison logic computes percentile rank, sector average/high/low from overall_score values
  - The function fetches peer stocks from the same sector and ranks them by vetrScore field from stocks table
  - This story served as a validation checkpoint to ensure the comparison logic wasn't affected by the schema migration
  - Similar to VS2-012 (score trend), comparison functions that only use overall_score require no changes for V2 schema
---
## VS2-014: Update admin endpoint and stock DTOs
Status: ✅ COMPLETE
Date: 2026-02-15
Details:
- Reviewed POST /admin/stocks/:ticker/recalculate-score endpoint (admin.routes.ts:359-393)
- Endpoint already returns new 4-pillar format: overall_score, components (4 pillars with scores/weights/sub_scores), null_pillars array, calculated_at
- Verified GET /stocks (stocks.routes.ts:36-67) returns vetr_score as integer (stock.vetrScore mapped to vetr_score field)
- Verified GET /stocks/:ticker (stocks.routes.ts:216-271) returns vetr_score as integer (detail.stock.vetrScore mapped to vetr_score field)
- Verified GET /stocks/search (stocks.routes.ts:76-98) returns vetr_score as integer
- Verified GET /stocks/:ticker/filings, GET /stocks/:ticker/executives also use correct stock DTO mapping
- No references to old column names (pedigreeScore, filingVelocityScore, etc.) found in stocks.routes.ts or admin.routes.ts
- sortableColumns array in admin.routes.ts line 184 already updated to new pillar names (from VS2-012)
- Build passes successfully
- **Learnings for future iterations:**
  - VS2-014 was already satisfied by previous implementations (VS2-009 updated admin endpoint, VS2-012 updated sortableColumns)
  - This story served as a validation checkpoint to ensure all public API contracts are correct after schema migration
  - Stock DTOs consistently map vetrScore (DB camelCase) to vetr_score (API snake_case) as an integer
  - Admin recalculate endpoint returns the full score breakdown (4 pillars + sub-scores), while stock list/detail endpoints only return the integer overall score
  - This separation of concerns is correct: detailed score breakdown for admin/analytics, simple integer score for stock listings
  - All stock route handlers follow the same DTO mapping pattern: snake_case for all JSON fields
---
## VS2-015: Update stock seed to remove hardcoded scores
Status: ✅ COMPLETE
Date: 2026-02-15
Details:
- Updated src/db/seed/stocks.ts to set vetrScore: 0 for all 25 stocks in stockSeedData array
- Changed all hardcoded scores (ranging from 35 to 91) to 0
- Scores will now be computed dynamically after seeding using the new 4-pillar VETTR Score V2 calculation
- The seedStocks() function upsert logic remains unchanged - it will still set vetrScore to 0 on conflict
- Build passes successfully
- **Learnings for future iterations:**
  - Removing hardcoded scores ensures that the database reflects the true computed values from the new score engine
  - Setting scores to 0 rather than null is intentional - null would indicate "never calculated", while 0 indicates "not yet calculated"
  - The seed-then-recalculate pattern (implemented in VS2-016) ensures all stocks get properly scored after seed data is loaded
  - This change affects all 25 stocks: NXE, ARIS, LUN, FM, TKO, ERO, CS, MAG, FVI, WPM, AEM, OR, ELD, SII, BTO, NGD, IMG, MND, LUG, KRR, RIO, SBB, GPL, FR, AG
  - The onConflictDoUpdate in seedStocks() will overwrite any existing scores with 0, which is correct for reseeding scenarios
---

# Ralph Progress Log - VETTR Ops Dashboard
Started: Sun Feb  8 17:51:15 EST 2026
Project: VETTR Ops Dashboard
Backend: /Users/manav/Space/code/vettr-backend
Frontend: /Users/manav/Space/code/vettr-ops-dashboard
---

## OPS-001: Create generic admin CRUD service
Status: COMPLETE
Date: 2026-02-08
Working Directory: /Users/manav/Space/code/vettr-backend
Details:
- Created src/services/admin-crud.service.ts with AdminCrudService class
- Implemented listRecords<T>() with pagination (limit/offset), search (ILIKE across configured columns), sort (column:direction), and filters (exact match on configured columns)
- Implemented getById<T>() that throws NotFoundError when record doesn't exist
- Implemented createRecord<T>() using Drizzle's insert().values().returning()
- Implemented updateRecord<T>() that checks existence first, then updates
- Implemented deleteRecord() that checks existence first, returns { deleted: true }
- All methods are generic and work with any PgTable from Drizzle
- Used drizzle-orm operators: eq, ilike, or, and, asc, desc
- All local imports use .js extension (ESM requirement)
- npm run build and npm run typecheck both pass
Files changed:
- src/services/admin-crud.service.ts (created)

**Learnings for future iterations:**
- Drizzle ORM patterns: Use table[column] as any for dynamic column access in generic functions
- The db export from config/database.ts can be null, so services must check before use
- PaginationMeta type from src/types/pagination.ts has { total, limit, offset, has_more }
- Error classes from src/utils/errors.ts: NotFoundError, ValidationError, etc.
- All TypeScript ESM imports must use .js extension in import paths
---
## OPS-002: Create admin CRUD route factory
Status: COMPLETE
Date: 2026-02-08
Working Directory: /Users/manav/Space/code/vettr-backend
Details:
- Created src/routes/admin-crud.factory.ts with createAdminCrudRoutes function
- Implemented GET / route that calls AdminCrudService.listRecords with query params (limit, offset, search, sort, filter_*)
- Implemented GET /:id route that calls AdminCrudService.getById and returns success(record)
- Implemented POST / route that calls AdminCrudService.createRecord and returns success(record) with 201 status
- Implemented PUT /:id route that calls AdminCrudService.updateRecord and returns success(record)
- Implemented DELETE /:id route that calls AdminCrudService.deleteRecord and returns success({ deleted: true })
- Added validateListParams function to validate limit (1-100), offset (>=0), and sort format (column:asc|desc)
- Added extractFilters function to extract filter_* params from query string
- All routes use paginated() or success() response helpers from src/utils/response.ts
- All local imports use .js extension (ESM requirement)
- npm run build and npm run typecheck both pass
Files changed:
- src/routes/admin-crud.factory.ts (created)

**Learnings for future iterations:**
- Hono router patterns: new Hono() creates a router, c.req.query() gets query params, c.req.param() gets route params, c.req.json() parses body
- Query parameter validation: Use ValidationError from src/utils/errors.ts for invalid params
- Filter extraction pattern: filter_* prefix in query params maps to actual column names
- Response helpers: paginated() for list endpoints, success() for single records, 201 status for POST
- CrudRouteConfig interface defines the contract for table configuration (tableName, table, primaryKey, searchableColumns, filterableColumns, sortableColumns)
---

## OPS-003: Add CSV/JSON export endpoint to CRUD factory
Status: COMPLETE
Date: 2026-02-08
Working Directory: /Users/manav/Space/code/vettr-backend
Details:
- Added GET /export route to the admin CRUD factory router
- Implemented format parameter (csv|json, default json) with validation
- Implemented escapeCsvValue() function that properly escapes commas, quotes, and newlines by wrapping in double quotes and escaping existing quotes as double-double-quotes
- Implemented generateCsv() function that creates CSV with header row from object keys and data rows from values
- Export endpoint fetches ALL matching records (limit 100000, offset 0) using the same search, sort, and filter params as the list endpoint
- CSV format: sets Content-Type to text/csv and Content-Disposition header with filename={tableName}-export.csv
- JSON format: sets Content-Type to application/json and returns raw array of records (no pagination wrapper)
- All local imports use .js extension (ESM requirement)
- npm run build and npm run typecheck both pass
Files changed:
- src/routes/admin-crud.factory.ts (modified - added export endpoint and CSV generation functions)

**Learnings for future iterations:**
- Hono response patterns: c.header() sets response headers, c.body() sends raw string response, c.json() sends JSON
- CSV escaping rules: wrap in quotes if contains comma/quote/newline, escape quotes by doubling them
- Export endpoints should bypass pagination to return all matching records
- Content-Disposition header format: attachment; filename=name.ext triggers browser download
- All admin routes generated by the factory automatically inherit admin auth middleware when mounted in admin.routes.ts
---
## OPS-004: Add bulk operations to CRUD factory
Status: COMPLETE
Date: 2026-02-08
Working Directory: /Users/manav/Space/code/vettr-backend
Details:
- Added POST /bulk route to admin-crud.factory.ts for bulk creating multiple records
- Implemented validation for body.records: must be non-empty array
- POST /bulk inserts all records using db.insert(table).values(records) and returns success({ created: count })
- Added DELETE /bulk route for bulk deleting records by IDs
- Implemented validation for body.ids: must be non-empty array of strings
- DELETE /bulk uses inArray operator on the primary key column to delete all matching records
- Both endpoints return ValidationError (422) if validation fails
- Added required imports: inArray from drizzle-orm and db from config/database.js
- All local imports use .js extension (ESM requirement)
- npm run build and npm run typecheck both pass
Files changed:
- src/routes/admin-crud.factory.ts (modified - added POST /bulk and DELETE /bulk routes)

**Learnings for future iterations:**
- Drizzle bulk insert pattern: db.insert(table).values(array) accepts an array of objects for bulk insertion
- Drizzle bulk delete pattern: db.delete(table).where(inArray(primaryKeyColumn, idsArray)) for deleting multiple records
- inArray operator from drizzle-orm is the equivalent of SQL's IN clause for array matching
- ValidationError should be thrown for empty arrays or missing required fields in request body
- For bulk operations, we can return the count of affected records directly from the array length
---
## OPS-005: Update CORS to allow ops dashboard origin
Status: COMPLETE
Date: 2026-02-08
Working Directory: /Users/manav/Space/code/vettr-backend
Details:
- Updated CORS configuration in src/app.ts to support multiple comma-separated origins
- Implemented origin parsing logic: splits CORS_ORIGIN by comma, trims whitespace, and creates a function to check against the allowed origins list
- Maintains backward compatibility: when CORS_ORIGIN is '*', it passes the wildcard directly to the cors() middleware
- When CORS_ORIGIN contains multiple origins (e.g., 'http://localhost:5173,http://localhost:3000'), the middleware now accepts requests from any origin in the list
- The default CORS_ORIGIN value in src/config/env.ts remains '*' for backward compatibility with mobile clients
- Preflight OPTIONS requests will receive correct Access-Control-Allow-Origin headers based on the requesting origin
- All local imports use .js extension (ESM requirement)
- npm run build and npm run typecheck both pass
Files changed:
- src/app.ts (modified - added CORS origin parsing logic)

**Learnings for future iterations:**
- Hono's cors() middleware accepts either a string or a function for the origin option
- When using a function, it receives the origin string from the request and should return the origin to allow (or null/false to deny)
- CORS origin parsing pattern: split by comma, trim whitespace, check against allowed list
- The cors middleware credentials: true option allows cookies and credentials to be sent cross-origin
- Wildcard '*' should be passed directly as a string, not as a function, for maximum compatibility
---
## OPS-006: Register admin CRUD routes for users table
Status: COMPLETE
Date: 2026-02-08
Working Directory: /Users/manav/Space/code/vettr-backend
Details:
- Registered CRUD routes for the users table in src/routes/admin.routes.ts
- Imported createAdminCrudRoutes from ./admin-crud.factory.js and users table from ../db/schema/index.js
- Created users routes with config: tableName 'users', primaryKey 'id', searchableColumns ['email', 'displayName'], filterableColumns ['tier', 'authProvider'], sortableColumns ['email', 'displayName', 'tier', 'createdAt', 'updatedAt']
- Mounted the users routes at /users path using adminRoutes.route('/users', usersRoutes)
- Full path is now /v1/admin/users with all CRUD operations: GET /, GET /:id, POST /, PUT /:id, DELETE /:id, GET /export, POST /bulk, DELETE /bulk
- Users can be searched by email and displayName with ?search=query parameter
- Users can be filtered by tier and authProvider with ?filter_tier=value and ?filter_authProvider=value
- Users can be sorted by email, displayName, tier, createdAt, updatedAt with ?sort=column:asc|desc
- All local imports use .js extension (ESM requirement)
- npm run build and npm run typecheck both pass
Files changed:
- src/routes/admin.routes.ts (modified - added users CRUD routes registration)

**Learnings for future iterations:**
- Route mounting pattern: adminRoutes.route('/path', subrouter) mounts a Hono sub-router at the specified path
- The createAdminCrudRoutes factory returns a complete Hono router with all CRUD endpoints already configured
- Since admin auth middleware is applied globally via adminRoutes.use('*', adminAuthMiddleware), all mounted sub-routes automatically inherit it
- Column names in searchableColumns, filterableColumns, and sortableColumns should match the actual database column names (camelCase in the schema definition)
- The users table has columns: id, email, displayName, avatarUrl, tier, passwordHash, authProvider, authProviderId, createdAt, updatedAt
---
## OPS-007: Register admin CRUD routes for stocks table
Status: COMPLETE
Date: 2026-02-08
Working Directory: /Users/manav/Space/code/vettr-backend
Details:
- Registered CRUD routes for the stocks table in src/routes/admin.routes.ts
- Imported stocks table from ../db/schema/index.js
- Created stocks routes with config: tableName 'stocks', primaryKey 'id', searchableColumns ['ticker', 'name'], filterableColumns ['exchange', 'sector'], sortableColumns ['ticker', 'name', 'exchange', 'sector', 'marketCap', 'price', 'vetrScore', 'updatedAt']
- Mounted the stocks routes at /stocks path using adminRoutes.route('/stocks', stocksRoutes)
- Full path is now /v1/admin/stocks with all CRUD operations: GET /, GET /:id, POST /, PUT /:id, DELETE /:id, GET /export, POST /bulk, DELETE /bulk
- Stocks can be searched by ticker and name with ?search=query parameter
- Stocks can be filtered by exchange and sector with ?filter_exchange=value and ?filter_sector=value
- Stocks can be sorted by ticker, name, exchange, sector, marketCap, price, vetrScore, updatedAt with ?sort=column:asc|desc
- All local imports use .js extension (ESM requirement)
- npm run build and npm run typecheck both pass
Files changed:
- src/routes/admin.routes.ts (modified - added stocks CRUD routes registration)

**Learnings for future iterations:**
- The stocks table has snake_case column names in the database (market_cap, price_change, vetr_score, updated_at) but camelCase in the Drizzle schema (marketCap, priceChange, vetrScore, updatedAt)
- When configuring sortableColumns, filterableColumns, and searchableColumns, always use the camelCase names from the schema definition, not the database column names
- The stocks table schema includes indexes on ticker, sector, and exchange for optimized filtering and searching
- Double precision columns (marketCap, price, priceChange) and integer columns (vetrScore) can be used for sorting and filtering
- The pattern for adding new table CRUD routes is consistent: import the table, create routes with createAdminCrudRoutes, mount with adminRoutes.route()
---
## OPS-008: Register admin CRUD routes for executives table
Status: COMPLETE
Date: 2026-02-08
Working Directory: /Users/manav/Space/code/vettr-backend
Details:
- Registered CRUD routes for the executives table in src/routes/admin.routes.ts
- Imported executives table from ../db/schema/index.js
- Created executives routes with config: tableName 'executives', primaryKey 'id', searchableColumns ['name', 'title', 'specialization'], filterableColumns ['stockId'], sortableColumns ['name', 'title', 'yearsAtCompany', 'createdAt', 'updatedAt']
- Mounted the executives routes at /executives path using adminRoutes.route('/executives', executivesRoutes)
- Full path is now /v1/admin/executives with all CRUD operations: GET /, GET /:id, POST /, PUT /:id, DELETE /:id, GET /export, POST /bulk, DELETE /bulk
- Executives can be searched by name, title, and specialization with ?search=query parameter
- Executives can be filtered by stockId with ?filter_stockId=value
- Executives can be sorted by name, title, yearsAtCompany, createdAt, updatedAt with ?sort=column:asc|desc
- All local imports use .js extension (ESM requirement)
- npm run build and npm run typecheck both pass
Files changed:
- src/routes/admin.routes.ts (modified - added executives CRUD routes registration)

**Learnings for future iterations:**
- The executives table has a foreign key reference to stocks via stockId, making it filterable by stock
- The executives table includes JSONB column previousCompanies for storing array of previous company names
- Searchable text columns include name, title, and specialization fields commonly used to find executives
- yearsAtCompany is a double precision field that can be sorted for tenure-based filtering
- Social media fields (socialLinkedin, socialTwitter) are available but not used for search/filter in the CRUD routes
- The pattern remains consistent: import table, create routes with createAdminCrudRoutes, mount with adminRoutes.route()
---
## OPS-009: Register admin CRUD routes for filings table
Status: COMPLETE
Date: 2026-02-08
Working Directory: /Users/manav/Space/code/vettr-backend
Details:
- Registered CRUD routes for the filings table in src/routes/admin.routes.ts
- Imported filings table from ../db/schema/index.js
- Created filings routes with config: tableName 'filings', primaryKey 'id', searchableColumns ['title', 'summary'], filterableColumns ['stockId', 'type', 'isMaterial'], sortableColumns ['title', 'type', 'date', 'isMaterial', 'createdAt']
- Mounted the filings routes at /filings path using adminRoutes.route('/filings', filingsRoutes)
- Full path is now /v1/admin/filings with all CRUD operations: GET /, GET /:id, POST /, PUT /:id, DELETE /:id, GET /export, POST /bulk, DELETE /bulk
- Filings can be searched by title and summary with ?search=query parameter
- Filings can be filtered by stockId, type, and isMaterial with ?filter_stockId=value, ?filter_type=value, and ?filter_isMaterial=value
- Filings can be sorted by title, type, date, isMaterial, createdAt with ?sort=column:asc|desc
- All local imports use .js extension (ESM requirement)
- npm run build and npm run typecheck both pass
Files changed:
- src/routes/admin.routes.ts (modified - added filings CRUD routes registration)

**Learnings for future iterations:**
- The filings table has a foreign key reference to stocks via stockId, enabling filtering by stock
- The filings table includes a boolean column isMaterial for marking important regulatory filings
- The type column stores filing type strings (10-K, 10-Q, 8-K, Press Release, etc.) for categorization
- title and summary are text fields suitable for ILIKE search operations
- The date column (timestamp) can be sorted to show filings chronologically
- The consistent pattern continues: import table, create routes with createAdminCrudRoutes, mount with adminRoutes.route()
---
## OPS-010: Register admin CRUD routes for alertRules table
Status: COMPLETE
Date: 2026-02-08
Working Directory: /Users/manav/Space/code/vettr-backend
Details:
- Registered CRUD routes for the alertRules table in src/routes/admin.routes.ts
- Imported alertRules table from ../db/schema/index.js
- Created alertRules routes with config: tableName 'alert-rules', primaryKey 'id', searchableColumns ['stockTicker', 'ruleType'], filterableColumns ['userId', 'stockTicker', 'ruleType', 'isActive', 'frequency'], sortableColumns ['stockTicker', 'ruleType', 'isActive', 'createdAt', 'lastTriggeredAt']
- Mounted the alertRules routes at /alert-rules path using adminRoutes.route('/alert-rules', alertRulesRoutes)
- Full path is now /v1/admin/alert-rules with all CRUD operations: GET /, GET /:id, POST /, PUT /:id, DELETE /:id, GET /export, POST /bulk, DELETE /bulk
- Alert rules can be searched by stockTicker and ruleType with ?search=query parameter
- Alert rules can be filtered by userId, stockTicker, ruleType, isActive, and frequency with ?filter_userId=value, ?filter_stockTicker=value, ?filter_ruleType=value, ?filter_isActive=value, and ?filter_frequency=value
- Alert rules can be sorted by stockTicker, ruleType, isActive, createdAt, lastTriggeredAt with ?sort=column:asc|desc
- All local imports use .js extension (ESM requirement)
- npm run build and npm run typecheck both pass
Files changed:
- src/routes/admin.routes.ts (modified - added alertRules CRUD routes registration)

**Learnings for future iterations:**
- The alertRules table has a foreign key reference to users via userId, enabling filtering by user
- The alertRules table includes a JSONB column triggerConditions for storing complex rule conditions as JSON
- The alertRules table has a boolean column isActive for enabling/disabling rules
- The frequency column stores scheduling strings (instant, daily, weekly, etc.) for alert frequency
- The lastTriggeredAt timestamp can be null and is sortable to show when rules were last triggered
- The consistent pattern continues: import table, create routes with createAdminCrudRoutes, mount with adminRoutes.route()
---
## OPS-011: Register admin CRUD routes for alerts table
Status: COMPLETE
Date: 2026-02-08
Working Directory: /Users/manav/Space/code/vettr-backend
Details:
- Registered CRUD routes for the alerts table in src/routes/admin.routes.ts
- Imported alerts table from ../db/schema/index.js
- Created alerts routes with config: tableName 'alerts', primaryKey 'id', searchableColumns ['title', 'message'], filterableColumns ['userId', 'stockId', 'alertType', 'isRead'], sortableColumns ['title', 'alertType', 'triggeredAt', 'isRead']
- Mounted the alerts routes at /alerts path using adminRoutes.route('/alerts', alertsRoutes)
- Full path is now /v1/admin/alerts with all CRUD operations: GET /, GET /:id, POST /, PUT /:id, DELETE /:id, GET /export, POST /bulk, DELETE /bulk
- Alerts can be searched by title and message with ?search=query parameter
- Alerts can be filtered by userId, stockId, alertType, and isRead with ?filter_userId=value, ?filter_stockId=value, ?filter_alertType=value, and ?filter_isRead=value
- Alerts can be sorted by title, alertType, triggeredAt, isRead with ?sort=column:asc|desc
- All local imports use .js extension (ESM requirement)
- npm run build and npm run typecheck both pass
Files changed:
- src/routes/admin.routes.ts (modified - added alerts CRUD routes registration)

**Learnings for future iterations:**
- The alerts table has foreign key references to users, stocks, and alertRules via userId, stockId, and alertRuleId
- The alerts table includes a boolean column isRead for tracking whether alerts have been viewed
- The alertType column stores alert type strings (price_change, red_flag, filing, etc.) for categorization
- title and message are text fields suitable for ILIKE search operations to find specific alerts
- The triggeredAt timestamp can be sorted to show alerts chronologically
- The consistent pattern continues: import table, create routes with createAdminCrudRoutes, mount with adminRoutes.route()
---
## OPS-012: Register admin CRUD routes for vetrScoreHistory table
Status: COMPLETE
Date: 2026-02-08
Working Directory: /Users/manav/Space/code/vettr-backend
Details:
- Registered CRUD routes for the vetrScoreHistory table in src/routes/admin.routes.ts
- Imported vetrScoreHistory table from ../db/schema/index.js
- Created vetrScoreHistory routes with config: tableName 'vetr-score-history', primaryKey 'id', searchableColumns ['stockTicker'], filterableColumns ['stockTicker'], sortableColumns ['stockTicker', 'overallScore', 'pedigreeScore', 'filingVelocityScore', 'redFlagScore', 'growthScore', 'governanceScore', 'calculatedAt']
- Mounted the vetrScoreHistory routes at /vetr-score-history path using adminRoutes.route('/vetr-score-history', vetrScoreHistoryRoutes)
- Full path is now /v1/admin/vetr-score-history with all CRUD operations: GET /, GET /:id, POST /, PUT /:id, DELETE /:id, GET /export, POST /bulk, DELETE /bulk
- VETR scores can be searched by stockTicker with ?search=query parameter
- VETR scores can be filtered by stockTicker with ?filter_stockTicker=value
- VETR scores can be sorted by stockTicker, overallScore, pedigreeScore, filingVelocityScore, redFlagScore, growthScore, governanceScore, calculatedAt with ?sort=column:asc|desc
- All local imports use .js extension (ESM requirement)
- npm run build and npm run typecheck both pass
Files changed:
- src/routes/admin.routes.ts (modified - added vetrScoreHistory CRUD routes registration)

**Learnings for future iterations:**
- The vetrScoreHistory table tracks historical VETR score calculations for stocks over time
- The table has integer columns for all score components (overallScore, pedigreeScore, filingVelocityScore, redFlagScore, growthScore, governanceScore)
- The table includes bonusPoints and penaltyPoints columns (integers with default 0) for score adjustments
- stockTicker is a varchar(20) column and is the main filterable/searchable field for this table
- calculatedAt timestamp can be sorted to show score calculations chronologically
- The consistent pattern continues: import table from schema/index.js, create routes with createAdminCrudRoutes, mount with adminRoutes.route()
---
## OPS-013: Register admin CRUD routes for redFlagHistory table
Status: COMPLETE
Date: 2026-02-08
Working Directory: /Users/manav/Space/code/vettr-backend
Details:
- Registered CRUD routes for the redFlagHistory table in src/routes/admin.routes.ts
- Imported redFlagHistory table from ../db/schema/index.js
- Created redFlagHistory routes with config: tableName 'red-flag-history', primaryKey 'id', searchableColumns ['stockTicker', 'description'], filterableColumns ['stockTicker', 'flagType', 'severity'], sortableColumns ['stockTicker', 'flagType', 'severity', 'score', 'detectedAt']
- Mounted the redFlagHistory routes at /red-flag-history path using adminRoutes.route('/red-flag-history', redFlagHistoryRoutes)
- Full path is now /v1/admin/red-flag-history with all CRUD operations: GET /, GET /:id, POST /, PUT /:id, DELETE /:id, GET /export, POST /bulk, DELETE /bulk
- Red flags can be searched by stockTicker and description with ?search=query parameter
- Red flags can be filtered by stockTicker, flagType, and severity with ?filter_stockTicker=value, ?filter_flagType=value, and ?filter_severity=value
- Red flags can be sorted by stockTicker, flagType, severity, score, detectedAt with ?sort=column:asc|desc
- All local imports use .js extension (ESM requirement)
- npm run build and npm run typecheck both pass
Files changed:
- src/routes/admin.routes.ts (modified - added redFlagHistory CRUD routes registration)

**Learnings for future iterations:**
- The redFlagHistory table tracks detected red flags for stocks with severity levels (Low, Moderate, High, Critical)
- The table includes columns: id (uuid), stockTicker (varchar), flagType (varchar), severity (varchar), score (double precision), description (text), detectedAt (timestamp)
- stockTicker and description are text fields suitable for ILIKE search operations to find specific red flags
- The severity column stores severity level strings for categorization and filtering
- The flagType column stores red flag type strings (insider_selling, etc.) for categorization
- The detectedAt timestamp can be sorted to show red flags chronologically
- The consistent pattern continues: import table from schema/index.js, create routes with createAdminCrudRoutes, mount with adminRoutes.route()
---
## OPS-014: Register admin CRUD routes for syncHistory table
Status: COMPLETE
Date: 2026-02-08
Working Directory: /Users/manav/Space/code/vettr-backend
Details:
- Registered CRUD routes for the syncHistory table in src/routes/admin.routes.ts
- Imported syncHistory table from ../db/schema/index.js
- Created syncHistory routes with config: tableName 'sync-history', primaryKey 'id', searchableColumns ['status'], filterableColumns ['userId', 'status'], sortableColumns ['startedAt', 'completedAt', 'itemsSynced', 'status']
- Mounted the syncHistory routes at /sync-history path using adminRoutes.route('/sync-history', syncHistoryRoutes)
- Full path is now /v1/admin/sync-history with all CRUD operations: GET /, GET /:id, POST /, PUT /:id, DELETE /:id, GET /export, POST /bulk, DELETE /bulk
- Sync history records can be searched by status with ?search=query parameter
- Sync history records can be filtered by userId and status with ?filter_userId=value and ?filter_status=value
- Sync history records can be sorted by startedAt, completedAt, itemsSynced, status with ?sort=column:asc|desc
- All local imports use .js extension (ESM requirement)
- npm run build and npm run typecheck both pass
Files changed:
- src/routes/admin.routes.ts (modified - added syncHistory CRUD routes registration)

**Learnings for future iterations:**
- The syncHistory table tracks user sync operations with timestamps (startedAt, completedAt), itemsSynced count, status (pending, success, failed), and errors text
- The table has a foreign key reference to users via userId, enabling filtering by user
- The status column stores status strings ('pending', 'success', 'failed') for categorization and filtering
- The errors column (text) can contain error messages for failed syncs
- The completedAt timestamp can be null for in-progress syncs and is sortable
- The consistent pattern continues: import table from schema/index.js, create routes with createAdminCrudRoutes, mount with adminRoutes.route()
---
## OPS-015: Register admin CRUD routes for userSettings table
Status: COMPLETE
Date: 2026-02-08
Working Directory: /Users/manav/Space/code/vettr-backend
Details:
- Registered CRUD routes for the userSettings table in src/routes/admin.routes.ts
- Imported userSettings table from ../db/schema/index.js (already exported in schema index)
- Created userSettings routes with config: tableName 'user-settings', primaryKey 'id', searchableColumns [], filterableColumns ['userId'], sortableColumns ['updatedAt']
- Mounted the userSettings routes at /user-settings path using adminRoutes.route('/user-settings', userSettingsRoutes)
- Full path is now /v1/admin/user-settings with all CRUD operations: GET /, GET /:id, POST /, PUT /:id, DELETE /:id, GET /export, POST /bulk, DELETE /bulk
- User settings can be filtered by userId with ?filter_userId=value
- User settings can be sorted by updatedAt with ?sort=updatedAt:asc|desc
- No searchable columns since settings are JSONB and userId is a UUID
- All local imports use .js extension (ESM requirement)
- npm run build and npm run typecheck both pass
Files changed:
- src/routes/admin.routes.ts (modified - added userSettings CRUD routes registration)

**Learnings for future iterations:**
- The userSettings table has a foreign key reference to users via userId with unique constraint (one settings record per user)
- The userSettings table includes a JSONB column settings for storing arbitrary user preference data as a JSON object
- The settings column has a default value of {} (empty object) and is not nullable
- Since settings is a JSONB field, it's not suitable for ILIKE text search, so searchableColumns is empty
- The updatedAt timestamp is the primary sortable field for this table
- The consistent pattern continues: import table from schema/index.js, create routes with createAdminCrudRoutes, mount with adminRoutes.route()
---
## OPS-016: Register admin CRUD routes for refreshTokens table
Status: COMPLETE
Date: 2026-02-08
Working Directory: /Users/manav/Space/code/vettr-backend
Details:
- Registered CRUD routes for the refreshTokens table in src/routes/admin.routes.ts
- Imported refreshTokens table from ../db/schema/index.js (already exported from users.ts)
- Created refreshTokens routes with config: tableName 'refresh-tokens', primaryKey 'id', searchableColumns [], filterableColumns ['userId', 'isRevoked'], sortableColumns ['expiresAt', 'isRevoked', 'createdAt']
- Mounted the refreshTokens routes at /refresh-tokens path using adminRoutes.route('/refresh-tokens', refreshTokensRoutes)
- Full path is now /v1/admin/refresh-tokens with all CRUD operations: GET /, GET /:id, POST /, PUT /:id, DELETE /:id, GET /export, POST /bulk, DELETE /bulk
- Refresh tokens can be filtered by userId and isRevoked with ?filter_userId=value and ?filter_isRevoked=value
- Refresh tokens can be sorted by expiresAt, isRevoked, createdAt with ?sort=column:asc|desc
- No searchable columns since the table contains UUIDs and token hashes which are not suitable for ILIKE search
- All local imports use .js extension (ESM requirement)
- npm run build and npm run typecheck both pass
Files changed:
- src/routes/admin.routes.ts (modified - added refreshTokens CRUD routes registration)

**Learnings for future iterations:**
- The refreshTokens table has a foreign key reference to users via userId with cascade delete, enabling filtering by user
- The refreshTokens table includes a boolean column isRevoked for marking tokens as revoked/invalid
- The tokenHash column stores hashed refresh tokens (varchar 255) for authentication security
- The expiresAt timestamp indicates when tokens expire and is sortable for cleanup operations
- Tables containing only UUIDs, hashes, and timestamps should have empty searchableColumns array
- The consistent pattern continues: import table from schema/index.js, create routes with createAdminCrudRoutes, mount with adminRoutes.route()
---
## OPS-017: Admin CRUD for composite primary key tables
Status: COMPLETE
Date: 2026-02-08
Working Directory: /Users/manav/Space/code/vettr-backend
Details:
- Created src/routes/admin-composite-pk.routes.ts with custom routes for three composite PK tables
- Implemented watchlistItems routes at /v1/admin/watchlist-items with GET / (list with pagination, filterable by userId and stockId), POST / (create with { userId, stockId }), DELETE / (delete by composite key)
- Implemented filingReads routes at /v1/admin/filing-reads with GET / (list with pagination, filterable by userId and filingId), POST / (create with { userId, filingId }), DELETE / (delete by composite key)
- Implemented redFlagAcknowledgments routes at /v1/admin/red-flag-acknowledgments with GET / (list with pagination, filterable by userId and redFlagId), POST / (create with { userId, redFlagId }), DELETE / (delete by composite key)
- All list endpoints return paginated response format using paginated() helper with { success, data: { items, pagination }, meta }
- POST endpoints return 201 status with created record wrapped in success()
- DELETE endpoints return success({ deleted: true }) and throw NotFoundError if record not found
- Used drizzle-orm's and(eq(column1, value1), eq(column2, value2)) for composite key lookups in WHERE clauses
- Added db null checks at the start of each route handler to satisfy TypeScript strict null checking
- Registered all three route groups in src/routes/admin.routes.ts with proper documentation comments
- All local imports use .js extension (ESM requirement)
- npm run build and npm run typecheck both pass
Files changed:
- src/routes/admin-composite-pk.routes.ts (created)
- src/routes/admin.routes.ts (modified - imported and registered composite PK routes)

**Learnings for future iterations:**
- Composite primary key tables require custom routes instead of the generic factory since they lack a single 'id' column
- Drizzle composite key pattern: and(eq(table.column1, value1), eq(table.column2, value2)) for WHERE clauses
- DELETE endpoints for composite PK tables should accept the composite key fields in the request body (not URL params)
- The db instance from config/database.ts can be null, so all route handlers need null checks: if (!db) throw new Error('Database not initialized')
- For composite PK tables, pagination works the same way as single-PK tables using sql<number>\`count(*)::int\` for total count
- All three composite PK tables have timestamp fields (addedAt, readAt, acknowledgedAt) which are good default sort fields using desc()
- The pattern for composite PK routes: export named Hono router instances instead of calling createAdminCrudRoutes factory
---
## OPS-018: Specialized admin action endpoints
Status: COMPLETE
Date: 2026-02-08
Working Directory: /Users/manav/Space/code/vettr-backend
Details:
- Added POST /v1/admin/users/:id/change-tier endpoint in src/routes/admin.routes.ts
- Implemented tier validation (free, pro, premium) with ValidationError for invalid values
- Endpoint updates user.tier column and returns { id, email, tier } in success response
- Added POST /v1/admin/stocks/:ticker/recalculate-score endpoint
- Implemented stock lookup by ticker with NotFoundError for non-existent stocks
- Invokes calculateVetrScore() from vetr-score.service.ts to recalculate score
- Updates stock.vetrScore field and creates new vetrScoreHistory record (done automatically by calculateVetrScore)
- Returns full score result with overall_score, components, bonus_points, penalty_points, calculated_at
- Added POST /v1/admin/seed/run endpoint
- Imports and calls runAllSeeds() from db/seed/index.js
- Returns success response with message and summary of seeded counts (stocks, filings, executives)
- All three endpoints inherit admin auth protection from adminRoutes.use('*', adminAuthMiddleware)
- All local imports use .js extension (ESM requirement)
- npm run build and npm run typecheck both pass
Files changed:
- src/routes/admin.routes.ts (modified - added three specialized endpoints)

**Learnings for future iterations:**
- Specialized admin endpoints can be added directly in admin.routes.ts for operations that don't fit the CRUD pattern
- The calculateVetrScore() function automatically saves to vetrScoreHistory and caches results, so no manual saving needed
- The runAllSeeds() function from db/seed/index.js handles all seeding logic including clearing and re-seeding tables
- When updating a stock's vetrScore field after recalculation, use db.update(stocks).set({ vetrScore }).where(eq(stocks.ticker, ticker))
- ValidationError should be used for input validation failures (invalid enum values, etc.)
- NotFoundError should be used when a resource doesn't exist (user ID, stock ticker, etc.)
- Type casting is needed for TypeScript when setting enum-like fields: tier as 'free' | 'pro' | 'premium'
- The seed endpoint can get counts after seeding by querying each table with db.select().from(table)
---

## OPS-019: Admin analytics endpoints
Status: COMPLETE
Date: 2026-02-08
Working Directory: /Users/manav/Space/code/vettr-backend
Details:
- Added GET /v1/admin/analytics/user-growth endpoint that queries users table grouped by DATE(created_at) for last 90 days
- Added GET /v1/admin/analytics/score-distribution endpoint that queries vetrScoreHistory for latest score per ticker, buckets scores into 5 ranges (0-20, 21-40, 41-60, 61-80, 81-100)
- Added GET /v1/admin/analytics/red-flag-trends endpoint that queries redFlagHistory grouped by DATE(detected_at) and severity for last 30 days
- Added GET /v1/admin/analytics/filing-activity endpoint that queries filings grouped by DATE(created_at) for last 30 days
- Added GET /v1/admin/analytics/alert-activity endpoint that queries alerts grouped by DATE(triggered_at) for last 30 days
- Added GET /v1/admin/analytics/tier-breakdown endpoint that queries users grouped by tier column
- Added GET /v1/admin/analytics/stock-health endpoint that returns 10 stocks with lowest vetrScore and 10 stocks with most red flags
- All 7 analytics endpoints implemented in src/routes/admin.routes.ts using raw SQL via drizzle-orm's sql template tag
- All endpoints return data in the standard success() response format: { success: true, data: {...}, meta: {...} }
- All endpoints inherit admin auth protection from adminRoutes.use('*', adminAuthMiddleware)
- All local imports use .js extension (ESM requirement)
- npm run build and npm run typecheck both pass
Files changed:
- src/routes/admin.routes.ts (modified - added 7 analytics endpoints)

**Learnings for future iterations:**
- Raw SQL queries in Drizzle: Use db.execute(sql`...`) for complex aggregations, GROUP BY, and window functions
- The sql template tag from drizzle-orm allows embedding raw SQL while maintaining type safety
- Cast PostgreSQL aggregates to int: COUNT(*)::int ensures integer return type instead of bigint
- Date grouping pattern: DATE(column_name) groups timestamps by date, useful for time series charts
- Window functions for latest records: SELECT DISTINCT ON (partition_column) ... ORDER BY partition_column, sort_column DESC gets the latest record per partition
- CASE WHEN for bucketing: Use CASE WHEN score BETWEEN x AND y THEN 'range' to bucket numeric values into ranges
- LEFT JOIN for counts: LEFT JOIN with COUNT gives zero counts for stocks with no red flags (vs INNER JOIN which excludes them)
- All analytics queries return arrays mapped to { date, count }, { range, count }, or { ticker, name, score/count } shapes
- PostgreSQL interval syntax: NOW() - INTERVAL '90 days' filters to last N days
- The result.rows from db.execute() returns an array of objects that need to be mapped to the desired shape with type assertions (row: any)
---
## OPS-020: Initialize Vite React TypeScript project for ops dashboard
Status: COMPLETE
Date: 2026-02-08
Working Directory: /Users/manav/Space/code/vettr-ops-dashboard
Details:
- Initialized new Vite React TypeScript project at /Users/manav/Space/code/vettr-ops-dashboard/
- Created package.json with all required production dependencies: react, react-dom, react-router v7, @tanstack/react-query v5, recharts v2, axios, react-hot-toast
- Created package.json with all required dev dependencies: @types/react, @types/react-dom, typescript, @vitejs/plugin-react, tailwindcss v4, @tailwindcss/vite, vite
- Configured vite.config.ts with React plugin, @tailwindcss/vite plugin, and server proxy for /v1 forwarding to http://localhost:3000/v1 with changeOrigin: true
- Set up TailwindCSS v4 in src/index.css using @import 'tailwindcss' directive (v4 uses CSS-based config instead of tailwind.config.js)
- Created minimal src/App.tsx with centered content showing "VETTR Ops Dashboard" title and description using Tailwind classes (bg-gray-900, text-white, text-4xl, etc.)
- Created src/main.tsx that renders App component into root element using ReactDOM.createRoot
- Created tsconfig.json with React JSX transform (jsx: "react-jsx"), strict mode enabled, and bundler moduleResolution
- Created tsconfig.node.json for Vite config compilation
- Created index.html as entry point with root div and module script tag
- Created .gitignore to exclude node_modules, dist, and editor files
- npm run build passes successfully with TypeScript compilation and Vite production build
Files changed:
- package.json (created)
- tsconfig.json (created)
- tsconfig.node.json (created)
- vite.config.ts (created)
- index.html (created)
- src/index.css (created)
- src/App.tsx (created)
- src/main.tsx (created)
- .gitignore (created)

**Learnings for future iterations:**
- Vite project structure: index.html at root, src/ for source files, vite.config.ts for configuration
- TailwindCSS v4 breaking change: Uses @import 'tailwindcss' in CSS instead of @tailwind directives from v3
- TailwindCSS v4 uses @tailwindcss/vite plugin instead of PostCSS plugin architecture
- React 18 with new JSX transform: No need to import React in component files, jsx: "react-jsx" in tsconfig handles it
- TypeScript strict mode catches unused imports: Remove React import when not using React.createElement or React types
- Vite proxy configuration pattern: server.proxy['/v1'] forwards API requests to backend, changeOrigin: true required for virtual hosts
- React Router v7 is the latest version (successor to v6), installed via react-router package
- @tanstack/react-query v5 is the latest version (formerly react-query), used for server state management
- Frontend does NOT need .js extensions in imports (Vite/TypeScript handles resolution automatically, unlike backend ESM)
- The frontend project uses a separate Git repository from the backend (separate commit history)
- Frontend build command: tsc && vite build (TypeScript check first, then Vite bundle for production)
---
## OPS-021: Create API client with admin auth interceptor
Status: COMPLETE
Date: 2026-02-08
Working Directory: /Users/manav/Space/code/vettr-ops-dashboard
Details:
- Created src/lib/api.ts with configured Axios API client
- Created Axios instance with baseURL '/v1' (which Vite proxy forwards to localhost:3000/v1)
- Implemented request interceptor that reads 'admin_secret' from sessionStorage and adds X-Admin-Secret header to every request
- Implemented response interceptor that handles 401 status by clearing sessionStorage and redirecting to /login
- Exported typed helper functions: apiGet<T>(), apiPost<T>(), apiPut<T>(), apiDelete<T>() that wrap the axios instance and return response.data typed as T
- Exported the raw axios instance as default export for direct access when needed
- All API calls will now automatically include the admin secret header and handle authentication failures
- npm run build passes with no TypeScript errors
Files changed:
- src/lib/api.ts (created)

**Learnings for future iterations:**
- Axios interceptor patterns: request interceptor for adding headers, response interceptor for error handling
- sessionStorage.getItem('admin_secret') retrieves the stored admin secret for authenticated requests
- window.location.href = '/login' triggers a full page redirect (React Router will handle the /login route)
- InternalAxiosRequestConfig type is used for request interceptor config parameter in Axios v1.x
- AxiosError type provides typed error objects with response.status for status code checking
- Helper functions that return response.data simplify API calls by unwrapping the Axios response envelope
- Frontend does NOT need .js extensions in imports (unlike backend ESM requirement)
- Vite proxy configuration in vite.config.ts handles forwarding /v1 requests to the backend server
---

## OPS-022: Create login page with admin secret authentication
Status: COMPLETE
Date: 2026-02-08
Working Directory: /Users/manav/Space/code/vettr-ops-dashboard
Details:
- Created src/pages/Login.tsx with authentication form
- Implemented password input field for admin secret with form validation
- Implemented handleSubmit function that calls GET /v1/admin/metrics with X-Admin-Secret header to verify credentials
- On successful authentication (200 response): stores secret in sessionStorage and navigates to '/' using React Router's useNavigate
- On authentication failure (401/403): displays "Invalid admin secret" error message in red
- On other errors: displays "Failed to connect to the server" error message
- Implemented loading state with animated spinner and disabled button during authentication request
- Styled with TailwindCSS: dark gray background (bg-gray-900), white card (bg-white rounded-lg shadow-xl), centered layout with flex
- Form includes proper labels, focus states (focus:ring-2 focus:ring-blue-500), and disabled states
- Button shows loading spinner animation during authentication with "Authenticating..." text
- npm run build passes with no TypeScript errors
Files changed:
- src/pages/Login.tsx (created)

**Learnings for future iterations:**
- React Router v7: Use useNavigate hook from 'react-router' (not 'react-router-dom') for programmatic navigation
- sessionStorage.setItem('admin_secret', secret) stores the admin secret for use in API interceptor
- Axios error handling: err.response?.status provides HTTP status code, err.response?.data contains error details
- Loading spinner pattern: Use animate-spin class on SVG for rotation animation, show loading text during async operations
- Form disabled state: disabled={isLoading || !secret} prevents submission while loading or when input is empty
- TailwindCSS focus states: focus:ring-2 focus:ring-blue-500 focus:border-blue-500 creates accessible focus indicators
- Error display pattern: Conditional rendering with {error && <div>...</div>} shows errors only when present
- Frontend imports: No .js extension needed (Vite handles module resolution automatically)
- React Router v7 imports: 'react-router' package provides useNavigate, not 'react-router-dom'
---

## OPS-023: Create app layout with sidebar navigation
Status: COMPLETE
Date: 2026-02-08
Working Directory: /Users/manav/Space/code/vettr-ops-dashboard
Details:
- Created src/components/Layout.tsx with responsive sidebar navigation
- Implemented fixed-width sidebar (w-64) with navigation links for all 16 admin sections (Dashboard, Users, Stocks, Executives, Filings, Alert Rules, Alerts, Watchlist Items, VETR Scores, Red Flags, Red Flag Acks, Sync History, User Settings, Refresh Tokens, Filing Reads, Bulk Import)
- Used React Router's NavLink component with active class highlighting (bg-blue-700 text-white for active, text-gray-300 for inactive)
- Implemented header bar with dynamic page title based on current route using useLocation hook
- Added Logout button that clears sessionStorage.removeItem('admin_secret') and navigates to /login
- Implemented mobile-responsive sidebar: hidden by default on mobile (< 768px), toggleable via hamburger menu button
- Added mobile overlay (bg-black bg-opacity-50) that closes sidebar when clicked outside
- Used <Outlet /> from React Router to render child route components in main content area
- Styled with TailwindCSS: dark sidebar (bg-gray-900 text-white), light content area (bg-gray-50), smooth transitions
- npm run build passes with no TypeScript errors
Files changed:
- src/components/Layout.tsx (created)

**Learnings for future iterations:**
- React Router v7: NavLink component accepts className as a function that receives { isActive } for conditional styling
- Mobile responsive pattern: Use transform translate-x classes with md: breakpoint prefix for sidebar visibility
- Sidebar overlay pattern: Fixed overlay with z-index layering (sidebar z-50, overlay z-40, content z-0)
- useState for sidebar toggle state: isSidebarOpen controls mobile sidebar visibility, hamburger button toggles it
- Dynamic page titles: Create a pageTitles record mapping paths to titles, use useLocation().pathname to get current path
- React Router v7 imports: useNavigate, useLocation, NavLink, Outlet all from 'react-router' package
- TailwindCSS transition classes: transition-transform duration-300 ease-in-out for smooth sidebar animations
- Logout pattern: Clear sessionStorage and use navigate('/login') for programmatic navigation
- Frontend directory: All frontend commits should be made in /Users/manav/Space/code/vettr-ops-dashboard/
---

## OPS-024: Configure React Router with protected routes
Status: COMPLETE
Date: 2026-02-08
Working Directory: /Users/manav/Space/code/vettr-ops-dashboard
Details:
- Created src/components/ProtectedRoute.tsx that checks sessionStorage for 'admin_secret'
- Created src/router.tsx with createBrowserRouter from React Router v7
- Defined unprotected /login route and all protected routes nested under ProtectedRoute and Layout components
- Created 17 placeholder page components for all admin sections (Dashboard, Users, UserDetail, Stocks, Executives, Filings, AlertRules, Alerts, WatchlistItems, VetrScores, RedFlags, RedFlagAcks, SyncHistory, UserSettings, RefreshTokens, FilingReads, BulkImport)
- All placeholder pages render basic heading and description with TailwindCSS styling
- Updated src/App.tsx to use QueryClientProvider with configured QueryClient (5 min staleTime, no refetch on window focus, retry: 1)
- Added RouterProvider with the router configuration
- Added Toaster component from react-hot-toast for notifications
- ProtectedRoute redirects to /login when admin_secret is not found in sessionStorage
- Browser back/forward navigation works correctly with all routes
- npm run build passes with no TypeScript errors
Files changed:
- src/components/ProtectedRoute.tsx (created)
- src/router.tsx (created)
- src/App.tsx (modified - replaced placeholder content with QueryClientProvider, RouterProvider, and Toaster)
- src/pages/Dashboard.tsx (created)
- src/pages/Users.tsx (created)
- src/pages/UserDetail.tsx (created)
- src/pages/Stocks.tsx (created)
- src/pages/Executives.tsx (created)
- src/pages/Filings.tsx (created)
- src/pages/AlertRules.tsx (created)
- src/pages/Alerts.tsx (created)
- src/pages/WatchlistItems.tsx (created)
- src/pages/VetrScores.tsx (created)
- src/pages/RedFlags.tsx (created)
- src/pages/RedFlagAcks.tsx (created)
- src/pages/SyncHistory.tsx (created)
- src/pages/UserSettings.tsx (created)
- src/pages/RefreshTokens.tsx (created)
- src/pages/FilingReads.tsx (created)
- src/pages/BulkImport.tsx (created)

**Learnings for future iterations:**
- React Router v7: createBrowserRouter is the recommended way to create routers (not BrowserRouter with Routes)
- ProtectedRoute pattern: Use <Navigate to="/login" replace /> to redirect unauthenticated users
- React Router v7: Nested routes use Outlet component - ProtectedRoute and Layout both render <Outlet /> for their children
- Route nesting: ProtectedRoute wraps Layout, Layout wraps all page routes - this creates the auth check  layout wrapper  page content hierarchy
- React Router v7 imports: All router components (Navigate, Outlet, NavLink, useNavigate, useLocation) from 'react-router' package (not 'react-router-dom')
- Default vs named exports: Layout and Login use default exports, so import them without curly braces
- QueryClient configuration: Set staleTime to reduce unnecessary refetches, disable refetchOnWindowFocus for admin dashboards
- Toaster positioning: Will be configured in later stories, but component must be included in App.tsx root
- Placeholder pages pattern: Simple function components with heading and description text, all using export function syntax (named exports)
- All frontend code compiles without .js extensions in imports (Vite handles module resolution automatically)
---
## OPS-025: Create shared UI components library
Status: COMPLETE
Date: 2026-02-08
Working Directory: /Users/manav/Space/code/vettr-ops-dashboard
Details:
- Created src/components/ui/StatCard.tsx with icon, title, value, and optional change props
- StatCard displays metric cards with green/red percentage change indicators based on positive/negative values
- Created src/components/ui/Badge.tsx with variant (success, warning, error, info) and label props
- Badge component uses distinct color schemes for each variant (green, yellow, red, blue) using TailwindCSS
- Created src/components/ui/FormField.tsx with label, name, type, value, onChange, error, and placeholder props
- FormField renders labeled input with error display in red text below the input when error is present
- Created src/components/ui/Modal.tsx with isOpen, onClose, title, and children props
- Modal renders fixed overlay with centered white card, clickable overlay background to close, X close button in header
- Created src/components/ui/ConfirmDialog.tsx extending Modal with message, onConfirm, confirmLabel, and variant props
- ConfirmDialog renders message text with Cancel and Confirm buttons, danger variant styles Confirm button red
- Created barrel export at src/components/ui/index.ts exporting all five UI components
- All components styled with TailwindCSS utility classes for consistent theming
- npm run build passes with no TypeScript errors
Files changed:
- src/components/ui/StatCard.tsx (created)
- src/components/ui/Badge.tsx (created)
- src/components/ui/FormField.tsx (created)
- src/components/ui/Modal.tsx (created)
- src/components/ui/ConfirmDialog.tsx (created)
- src/components/ui/index.ts (created)

**Learnings for future iterations:**
- React component patterns: Named exports (export function ComponentName) are used for consistency
- TailwindCSS color variants: Use object mapping for variant-based className selection (e.g., variantClasses[variant])
- Modal overlay pattern: Fixed inset-0 div with bg-black bg-opacity-50 creates darkened overlay
- Modal centering: flex min-h-full items-center justify-center p-4 centers modal on screen
- Modal z-index: Use z-50 for modal content, overlay can be lower z-index but still above regular content
- TypeScript props: Interface definitions for component props ensure type safety
- Optional props: Use ? for optional props (change?, error?, placeholder?) with default values or undefined checks
- Children prop type: React.ReactNode is the correct type for component children
- Event handlers: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement> for input onChange events
- Conditional rendering: {error && <element>} pattern shows elements only when condition is truthy
- SVG icons inline: Simple X icon using SVG path for close button, avoids external icon library dependency
- Frontend imports: No .js extension needed in imports (Vite handles module resolution)
- FormField input border: Use border-red-300 class when error exists to highlight validation issues
- ConfirmDialog composition: Wraps Modal component and adds confirmation-specific UI and behavior
- Button styling patterns: Use focus:outline-none focus:ring-2 for accessible keyboard focus indicators
---
## OPS-026: Create generic DataTable component
Status: COMPLETE
Date: 2026-02-08
Working Directory: /Users/manav/Space/code/vettr-ops-dashboard
Details:
- Created src/components/DataTable.tsx with full-featured data table component
- Implemented column configuration with key, label, render function, and sortable flag
- Implemented sortable table headers with visual sort indicators (up/down arrows)
- Clicking sortable header toggles between asc/desc and calls onSort callback
- Implemented row rendering that uses column.render for custom rendering or defaults to stringified value
- Added checkbox column for row selection with "select all" checkbox in header that toggles all visible rows
- Individual row checkboxes toggle selection state, tracked in Set<string> for efficient lookup
- Added indeterminate checkbox state when some (but not all) rows are selected
- Implemented actions column with Edit and Delete icon buttons that call onEdit/onDelete callbacks
- Created pagination controls below table with page size selector (10/25/50 options)
- Pagination shows "Showing X-Y of Z records" text and previous/next buttons
- Previous/next buttons disabled appropriately when at boundaries (offset=0 or has_more=false)
- Implemented loading skeleton with 6 rows of animated gray bars using animate-pulse
- Implemented empty state with centered icon and "No records found" message when data array is empty
- Table is horizontally scrollable on small screens using overflow-x-auto
- All state managed internally: selectedRows, sortColumn, sortDirection
- Selection changes trigger onSelectionChange callback with array of selected IDs
- TypeScript interfaces defined for Column, Pagination, and DataTableProps with generics
- npm run build passes with no TypeScript errors
Files changed:
- src/components/DataTable.tsx (created)

**Learnings for future iterations:**
- React Set for selection state: Set<string> provides O(1) lookup for checking if row is selected
- Checkbox indeterminate state: Must use ref callback to set input.indeterminate = true (not a prop)
- TypeScript generics for table data: DataTable<T extends Record<string, any>> allows type-safe row data
- useEffect dependency arrays: Include callbacks in deps or wrap in useCallback to avoid stale closures
- Reset selection on data change: useEffect with data in deps clears selection when table data changes
- Loading skeleton pattern: Array.from({ length: 6 }) creates placeholder rows during loading state
- Empty state colspan: Calculate total columns including checkbox and actions columns for full-width empty message
- SVG icons inline: Use inline SVG for edit/delete icons to avoid external dependencies
- Sort icon rotation: Use different SVG paths for up/down arrows instead of CSS transform
- Disabled button styling: disabled:opacity-50 disabled:cursor-not-allowed for visual feedback
- Table hover states: hover:bg-gray-50 on tr elements for better row visibility
- Pagination calculation: currentStart = offset + 1, currentEnd = min(offset + limit, total)
- Frontend TypeScript: No .js extension needed in imports (Vite handles module resolution)
- React.ReactNode type: Correct type for render function return values and children props
---
## OPS-027: Create search, filter, and export toolbar components
Status: COMPLETE
Date: 2026-02-08
Working Directory: /Users/manav/Space/code/vettr-ops-dashboard
Details:
- Created src/components/SearchInput.tsx with text input, search icon, and debounced onChange (300ms delay)
- Implemented clear (X) button that appears when input has value and resets the search
- Created src/components/FilterBar.tsx accepting filters prop with dynamic select dropdowns
- Implemented onFilterChange callback that fires when any dropdown changes with current filter state
- Added "Clear Filters" button that resets all dropdowns and only appears when filters are active
- Created src/components/ExportButton.tsx with dropdown menu showing CSV and JSON export options
- Implemented loading state with spinner animation inside button during export operations
- Created src/components/BulkActionBar.tsx showing selected count and Delete Selected button
- BulkActionBar styled as sticky bar at top with distinct blue background, only visible when selectedCount > 0
- All components use TailwindCSS utility classes for consistent styling and spacing
- npm run build passes with no TypeScript errors
Files changed:
- src/components/SearchInput.tsx (created)
- src/components/FilterBar.tsx (created)
- src/components/ExportButton.tsx (created)
- src/components/BulkActionBar.tsx (created)

**Learnings for future iterations:**
- Debounced search pattern: Use useEffect with setTimeout to delay API calls, clean up timer in return function
- useEffect cleanup: Return a cleanup function that calls clearTimeout(timer) to cancel pending timers on unmount or value change
- Controlled input pattern: Track input value in local state, fire callback after debounce delay
- Filter state management: Track selected filters in Record<string, string>, delete keys when set to empty string
- Dropdown menu pattern: Fixed overlay div covers screen to detect outside clicks, absolute positioned menu relative to button
- Z-index layering: Fixed overlay at z-10, dropdown menu at z-20 to ensure proper stacking
- Sticky positioning: Use sticky top-0 for BulkActionBar to keep it visible when scrolling table
- Conditional rendering: Return null from component when not needed (selectedCount === 0) instead of hiding with CSS
- SVG icon inline pattern: Use inline SVG paths for icons to avoid external dependencies (search, download, delete, check circle)
- Loading state UI: Show spinner animation with "Exporting..." text while loading prop is true, disable button
- TypeScript interface exports: No need to export interfaces used only within component file
- Frontend imports: No .js extension needed (Vite handles module resolution automatically)
- Filter dropdown styling: Use border border-gray-300 rounded-lg with focus:ring-2 for consistent form controls
- Clear button visibility: Use conditional rendering {hasActiveFilters && <button>} pattern for optional UI elements
---
## OPS-028: Create generic useTable hook for CRUD operations
Status: COMPLETE
Date: 2026-02-08
Working Directory: /Users/manav/Space/code/vettr-ops-dashboard
Details:
- Created src/hooks/useTable.ts with generic useTable<T> hook for data fetching and CRUD operations
- Implemented useQuery from @tanstack/react-query for fetching paginated data from GET /v1/admin/{endpoint}
- Query key includes [queryKey, page, pageSize, search, sort, filters] to auto-refetch when any param changes
- Implemented buildParams() helper to construct query params: limit, offset, search, sort (column:direction), and filter_* params spread from filters object
- Implemented createMutation using useMutation to POST /v1/admin/{endpoint} with onSuccess invalidating queries and showing toast
- Implemented updateMutation using useMutation to PUT /v1/admin/{endpoint}/:id with { id, data } params
- Implemented deleteMutation using useMutation to DELETE /v1/admin/{endpoint}/:id
- Implemented bulkDeleteMutation using useMutation to DELETE /v1/admin/{endpoint}/bulk with { ids } body
- All mutations include onSuccess callbacks that call queryClient.invalidateQueries({ queryKey: [queryKey] })
- All mutations include onError callbacks that extract error messages from err.response?.data?.error?.message and show toast.error()
- Success toasts show "{Action} {endpoint} successfully" messages (e.g., "Created users successfully")
- Hook returns: data (items array), pagination (PaginationMeta), isLoading, error, search/setSearch, sort/setSort, filters/setFilters, page/setPage, pageSize/setPageSize, all mutations, and refetch function
- TypeScript interfaces defined for TableConfig, PaginationMeta, ApiResponse<T>, and SingleApiResponse<T>
- npm run build passes with no TypeScript errors
Files changed:
- src/hooks/useTable.ts (created)

**Learnings for future iterations:**
- TanStack Query v5 patterns: useQuery with queryKey array, useMutation with mutationFn/onSuccess/onError
- Query invalidation: queryClient.invalidateQueries({ queryKey: [queryKey] }) refetches all queries matching the key
- Toast notifications: toast.success() and toast.error() from react-hot-toast for user feedback
- Axios error handling: err.response?.data?.error?.message extracts backend error messages
- Pagination offset calculation: offset = (page - 1) * pageSize for zero-based API offset
- Query params for filters: filter_* prefix pattern matches backend filter param expectations
- Generic TypeScript hook: useTable<T extends Record<string, any>> allows type-safe table data
- React state for table controls: useState for page, pageSize, search, sort, filters
- Mutation parameters: Update mutation needs { id, data } structure, delete needs just id string
- Bulk operations: bulkDeleteMutation accepts ids array and extracts count from response.data.deleted
- Frontend directory: All frontend commits in /Users/manav/Space/code/vettr-ops-dashboard/
- No .js extensions needed in frontend imports (Vite handles module resolution)
---
## OPS-029: Create useExport hook for file downloads
Status: COMPLETE
Date: 2026-02-08
Working Directory: /Users/manav/Space/code/vettr-ops-dashboard
Details:
- Created src/hooks/useExport.ts with useExport(endpoint: string) hook
- Implemented exportData(format: 'csv' | 'json', filters?: Record<string, string>) function
- Implemented isExporting state that is true during download request and false when complete
- exportData calls GET /v1/admin/{endpoint}/export?format={format} with filters as query params
- Uses axios with responseType: 'blob' to download binary data
- On success: creates Blob from response data, creates object URL with URL.createObjectURL()
- Creates temporary <a> element with href=objectURL and download attribute set to {endpoint}-export.{format}
- Programmatically clicks the link to trigger browser download
- Cleans up by removing the link element and revoking the object URL with URL.revokeObjectURL()
- Shows success toast notification when download completes
- On error: extracts error message from blob response (reads blob as text, parses JSON) or axios error
- Shows error toast notification with extracted error message
- npm run build passes with no TypeScript errors
Files changed:
- src/hooks/useExport.ts (created)

**Learnings for future iterations:**
- Blob download pattern: Use responseType: 'blob' in axios to receive binary data for file downloads
- Object URL creation: URL.createObjectURL(blob) creates a temporary URL that can be used in <a> href
- Programmatic download: Create temporary <a> element, set href and download attributes, call click(), then remove
- URL cleanup: Always call URL.revokeObjectURL() after download to release memory
- Blob error handling: When API returns error as blob (not JSON), read blob.text() and parse as JSON to extract error message
- Filter params pattern: Add filter_ prefix to filter object keys when passing to API (matches backend expectations)
- React state management: useState for isExporting boolean, set true before request, false in finally block
- Toast notifications: toast.success() for successful downloads, toast.error() for failures
- Frontend imports: No .js extension needed in imports (Vite handles module resolution)
- Working directory: Frontend stories use /Users/manav/Space/code/vettr-ops-dashboard/ for commits
---
## OPS-030: Create useAnalytics hooks for dashboard data
Status: COMPLETE
Date: 2026-02-08
Working Directory: /Users/manav/Space/code/vettr-ops-dashboard
Details:
- Created src/hooks/useAnalytics.ts with 8 dedicated analytics hooks
- Implemented useMetrics() hook with queryKey ['metrics'] fetching GET /v1/admin/metrics
- Implemented useUserGrowth() hook with queryKey ['analytics', 'user-growth'] for 90-day user growth data
- Implemented useScoreDistribution() hook for VETR score distribution buckets
- Implemented useRedFlagTrends() hook for 30-day red flag trends by severity
- Implemented useFilingActivity() hook for 30-day filing activity data
- Implemented useAlertActivity() hook for 30-day alert activity data
- Implemented useTierBreakdown() hook for user tier distribution
- Implemented useStockHealth() hook returning lowest scores and most flagged stocks
- All hooks use @tanstack/react-query's useQuery for data fetching and caching
- All hooks extract data from standard API response shape: response.data.data (API returns { success, data, meta })
- Added comprehensive TypeScript type definitions for all analytics data structures
- Each hook has JSDoc comments explaining its purpose and return data structure
- npm run build passes with no TypeScript errors
Files changed:
- src/hooks/useAnalytics.ts (created)

**Learnings for future iterations:**
- TanStack Query caching: Each hook has unique queryKey array for independent caching (e.g., ['analytics', 'user-growth'])
- API response extraction pattern: response.data.data extracts the nested data from { success, data: { data: [...] }, meta } structure
- TypeScript interface organization: Define interfaces for each data type (UserGrowthData, ScoreDistributionData, etc.) for type safety
- Generic API response types: ApiResponse<T> interface wraps the standard { success, data: T, meta } shape
- Analytics data structures: User growth and activity data use { date, count } shape, breakdown data uses { category, count } shape
- Stock health data: Combines two arrays (lowest_scores and most_flags) in a single response object
- Metrics data structure: Nested database_stats object contains counts for all tables, plus top-level performance metrics
- Hook naming convention: use{EntityName} pattern for clarity (useUserGrowth, useScoreDistribution, etc.)
- TanStack Query return type: useQuery returns { data, isLoading, error, refetch } for consumption by components
- Frontend imports: No .js extension needed in imports (Vite handles module resolution automatically)
- Working directory: All frontend commits in /Users/manav/Space/code/vettr-ops-dashboard/
---
## OPS-031: Dashboard page with metrics summary cards
Status: COMPLETE
Date: 2026-02-08
Working Directory: /Users/manav/Space/code/vettr-ops-dashboard
Details:
- Updated src/pages/Dashboard.tsx to display system metrics using useMetrics() hook
- Implemented 6 StatCard components showing: Total Users, Total Stocks, Total Filings, Total Alerts, Avg Response Time, and Uptime
- Each StatCard displays appropriate icon using inline SVG (users, chart, document, bell, clock, server icons)
- Added formatUptime() helper function to format uptime_seconds as days/hours/minutes (e.g., "5d 3h" or "12h" or "45m")
- Implemented loading skeleton state with 6 animated placeholder cards using animate-pulse
- Implemented error state with red error banner when metrics request fails
- Used responsive grid layout: 1 column on mobile, 2 on md, 3 on lg, 4 on xl breakpoints
- All metric values formatted with toLocaleString() for thousand separators
- npm run build passes with no TypeScript errors
Files changed:
- src/pages/Dashboard.tsx (modified)

**Learnings for future iterations:**
- TailwindCSS responsive grid: grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 creates adaptive layout
- Loading skeleton pattern: Array spread [...Array(6)] creates placeholder elements, animate-pulse adds loading animation
- Optional chaining for safe access: metrics?.database_stats.users prevents crashes when data is undefined during loading
- Uptime formatting: Convert seconds to days/hours/minutes using Math.floor and modulo operations
- SVG icon inline pattern: Use inline SVG with stroke="currentColor" to inherit text color from Tailwind classes
- useMetrics() hook returns { data, isLoading, error } from TanStack Query for complete query state
- Error handling pattern: Check error state first and return early with error UI before rendering main content
- Frontend Dashboard component is already registered in router.tsx from OPS-024 (routes defined for all pages)
- The StatCard component displays optional change percentage but metrics endpoint doesn't provide change data yet
- Frontend directory: All frontend commits in /Users/manav/Space/code/vettr-ops-dashboard/
---
## OPS-032: Dashboard user growth line chart
Status: COMPLETE
Date: 2026-02-08
Working Directory: /Users/manav/Space/code/vettr-ops-dashboard
Details:
- Added user growth line chart section to src/pages/Dashboard.tsx below the metrics cards
- Imported useUserGrowth hook from hooks/useAnalytics and Recharts components (LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer)
- Created formatChartDate() helper function to format dates as 'MMM DD' for the X-axis labels
- Implemented loading skeleton with animated gray bars during data fetch
- Implemented Recharts LineChart with 300px height wrapped in ResponsiveContainer
- Configured XAxis with date formatting using formatChartDate tickFormatter
- Configured YAxis with count values and gray stroke color
- Configured Tooltip with custom styling (white background, border, rounded corners) and formatted labels
- Implemented Line component with blue stroke (#3b82f6), 2px width, dots at data points, and active dot highlighting
- Added empty state with icon and "No data available" message when data array is empty
- Chart wrapped in white card with "User Growth (90 Days)" title, rounded corners, and shadow
- npm run build passes with no TypeScript errors
Files changed:
- src/pages/Dashboard.tsx (modified)

**Learnings for future iterations:**
- Recharts ResponsiveContainer: Use width="100%" and fixed height (e.g., 300) for responsive charts that maintain aspect ratio
- Recharts XAxis tickFormatter: Pass a function to format tick labels (e.g., formatChartDate for date formatting)
- Recharts Tooltip customization: Use contentStyle, labelFormatter, and formatter props for custom tooltip appearance and content
- Date formatting pattern: Use date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) for 'MMM DD' format
- Recharts Line component: type="monotone" creates smooth curved lines, strokeWidth controls line thickness, dot and activeDot configure point markers
- Loading skeleton for charts: Use a flexbox container with animated pulse bars to indicate loading state
- Empty state pattern: Show centered icon and message when data array is empty or undefined
- CartesianGrid: Use strokeDasharray="3 3" for dashed grid lines, stroke="#e5e7eb" for subtle gray color
- Color scheme: Use Tailwind blue (#3b82f6) for primary chart colors, gray (#6b7280) for axes and text
- Frontend Recharts imports: Import specific components from 'recharts' package (not 'recharts/lib' submodules)
- TypeScript Tooltip formatter: Type the value parameter as number for proper type safety in Tooltip formatter functions
---
## OPS-033: Dashboard score distribution bar chart and tier breakdown pie chart
Status: COMPLETE
Date: 2026-02-08
Working Directory: /Users/manav/Space/code/vettr-ops-dashboard
Details:
- Added score distribution bar chart and tier breakdown pie chart to Dashboard.tsx below the user growth chart
- Imported useScoreDistribution and useTierBreakdown hooks from useAnalytics.ts
- Imported additional Recharts components: BarChart, Bar, PieChart, Pie, Cell, Legend
- Created two-column chart section using grid grid-cols-1 lg:grid-cols-2 gap-6 for responsive layout
- Implemented score distribution bar chart (left column):
  - Uses useScoreDistribution() hook to fetch score range buckets (0-20, 21-40, 41-60, 61-80, 81-100)
  - Renders Recharts BarChart with XAxis showing score ranges and YAxis showing count
  - Each bar colored by range using getScoreColor() helper: red (#ef4444) for 0-40, yellow (#eab308) for 41-80, green (#22c55e) for 81-100
  - Used Cell component to apply individual colors to each bar
  - Wrapped in ResponsiveContainer with height 300 inside white card with title "VETR Score Distribution"
- Implemented tier breakdown pie chart (right column):
  - Uses useTierBreakdown() hook to fetch user tier distribution (free, pro, premium)
  - Renders Recharts PieChart with distinct colors per tier: gray (#94a3b8) for free, blue (#3b82f6) for pro, amber (#f59e0b) for premium
  - Pie labels show tier name, count, and percentage: "tier: count (percent%)"
  - Used Cell component with tierColors mapping to apply colors
  - Added Legend at bottom with formatted tier names (capitalized)
  - Wrapped in ResponsiveContainer with height 300 inside white card with title "User Tier Breakdown"
- Both charts show loading skeletons with animate-pulse while data loads
- Both charts show "No data available" empty state with icon when data arrays are empty
- npm run build passes with no TypeScript errors
Files changed:
- src/pages/Dashboard.tsx (modified - added score distribution bar chart and tier breakdown pie chart)

**Learnings for future iterations:**
- Recharts BarChart pattern: Use Bar with dataKey="count", apply individual colors using Cell component and map over data
- Recharts Bar styling: radius={[4, 4, 0, 0]} rounds the top corners of bars for a modern look
- Recharts Cell component: Wrap inside Bar/Pie to apply individual colors to each data point, use fill prop with color value
- Recharts PieChart pattern: Use Pie with cx="50%" cy="50%" for centering, labelLine={false} to disable label lines
- Pie chart labels: label prop accepts function receiving { tier, count, percent } to customize label text
- Pie chart Legend: Use Legend component with verticalAlign="bottom" height={36}, formatter function to transform legend labels
- Color helper functions: Create getScoreColor() function to map score ranges to colors based on range prefix
- Color mapping objects: tierColors Record<string, string> maps tier names to specific colors for consistent theming
- Two-column responsive layout: grid grid-cols-1 lg:grid-cols-2 gap-6 creates side-by-side charts on large screens, stacked on mobile
- Frontend Recharts imports: BarChart, Bar, PieChart, Pie, Cell, Legend all imported from 'recharts' package
- Empty state icons: Use appropriate SVG icons for different chart types (bar chart icon for bar chart, pie chart icon for pie chart)
- Working directory: All frontend commits in /Users/manav/Space/code/vettr-ops-dashboard/
---
## OPS-034: Dashboard red flags, filing activity, and stock health sections
Status: COMPLETE
Date: 2026-02-08
Working Directory: /Users/manav/Space/code/vettr-ops-dashboard
Details:
- Added red flag trends section to Dashboard.tsx using useRedFlagTrends() hook
- Implemented Recharts AreaChart with stacked areas per severity level (Low, Moderate, High, Critical) over 30 days
- Created transformRedFlagTrendsData() helper function to transform { date, severity, count } array into { date, Low, Moderate, High, Critical } format for stacked area chart
- Configured XAxis with date formatting, YAxis with count, distinct colors per severity (gray for Low, yellow for Moderate, amber for High, red for Critical)
- Added Tooltip showing all severity counts and Legend at top of chart
- Added filing activity section using useFilingActivity() hook with Recharts BarChart
- Bar chart shows daily filing counts for last 30 days with blue bars, XAxis as dates, YAxis as count
- Added stock health section using useStockHealth() hook
- Implemented two-column responsive grid layout (side-by-side on lg screens, stacked on mobile)
- Created "Lowest VETR Scores" table with ticker, name, score columns showing top 10 stocks with lowest scores
- Created "Most Red Flags" table with ticker, name, flag_count columns showing top 10 stocks with most red flags
- Both tables styled with TailwindCSS classes, hover states on rows, color-coded badges for scores (red <40, yellow 40-70, green >70)
- All three sections wrapped in white cards with titles, rounded corners, and shadows
- Implemented loading skeletons with animate-pulse for all three sections
- Implemented empty states with icons and "No data available" messages when data is empty
- npm run build passes with no TypeScript errors
Files changed:
- src/pages/Dashboard.tsx (modified - added red flag trends area chart, filing activity bar chart, and stock health tables)

**Learnings for future iterations:**
- Recharts AreaChart stacked pattern: Use stackId="1" on all Area components to create stacked areas, type="monotone" for smooth curves
- Data transformation for stacked charts: API returns { date, severity, count } rows, need to transform to { date, Low: x, Moderate: y, High: z, Critical: w } for Recharts stacked areas
- Map-based transformation: Use Map<string, Record<string, number>> to aggregate counts by date and severity, then convert to array
- Area component ordering: Areas are rendered in order, so list them from bottom to top for proper stacking visual (Low, Moderate, High, Critical)
- Legend positioning: verticalAlign="top" height={36} positions legend above chart for stacked area charts
- Table responsive layout: grid grid-cols-1 lg:grid-cols-2 gap-6 creates side-by-side tables on large screens, stacked on mobile
- Table styling patterns: Use bg-gray-50 for thead, divide-y divide-gray-200 for row separators, hover:bg-gray-50 for row hover
- Score badge coloring: Inline conditional className based on score value for dynamic color (red/yellow/green backgrounds)
- Truncate long text: truncate max-w-[200px] classes prevent table cell overflow for long stock names
- Empty state for tables: Show "No data available" text when array is empty or undefined
- Frontend working directory: All frontend commits in /Users/manav/Space/code/vettr-ops-dashboard/
- Recharts imports: AreaChart and Area components imported from 'recharts' package for area/line charts
---
## OPS-035: Users table page with full CRUD
Status: COMPLETE
Date: 2026-02-08
Working Directory: /Users/manav/Space/code/vettr-ops-dashboard
Details:
- Created complete Users page implementation in src/pages/Users.tsx replacing placeholder
- Integrated useTable<User> hook with endpoint 'users' and queryKey 'admin-users' for data fetching and CRUD operations
- Implemented SearchInput component for searching by email and displayName (debounced)
- Implemented FilterBar with two filters: tier (free/pro/premium) and authProvider (email/google/apple)
- Implemented ExportButton with useExport hook for CSV/JSON exports
- Created DataTable with 5 columns: email, displayName (with null handling), tier (Badge with color variants), authProvider (capitalized), createdAt (formatted date)
- All columns except authProvider are sortable (email, displayName, tier, createdAt)
- Implemented Create User modal with form validation (email format, required fields)
- Implemented Edit User modal with same form fields, pre-populated with user data
- Form fields include: email (with validation), displayName (required), tier (select dropdown), authProvider (select dropdown)
- Implemented delete confirmation using ConfirmDialog with danger variant
- Implemented row selection with BulkActionBar showing count and bulk delete action
- All CRUD operations use mutations from useTable hook with proper error/success handling
- Success toast notifications shown after create/update/delete operations
- Error handling delegated to useTable hook mutations which show error toasts automatically
- Fixed TypeScript errors: SearchInput manages its own internal value state, ConfirmDialog doesn't accept title prop
- Removed unused variables (page, sort) to satisfy TypeScript strict mode
- npm run build passes with no TypeScript errors
Files changed:
- src/pages/Users.tsx (modified - complete CRUD implementation)

**Learnings for future iterations:**
- SearchInput component pattern: Manages its own internal state for value, takes only onSearch callback (no value prop needed)
- ConfirmDialog simplification: Uses hardcoded "Confirm Action" title in Modal, only takes message and variant props
- useTable hook returns destructured values: Don't destructure unused values like page/sort if not needed (TypeScript strict mode)
- Form validation pattern: Create validateForm() function that sets errors object, return boolean for valid/invalid
- Modal state management: Separate boolean state for each modal (isCreateModalOpen, isEditModalOpen, isDeleteDialogOpen)
- Form data initialization: Reset formData and formErrors when opening create modal, populate when opening edit modal
- Mutation success handling: Use try/catch with mutateAsync to handle both success (close modal, show toast) and errors (handled by hook)
- Badge variant mapping: tier='premium'  success, tier='pro'  info, tier='free'  warning for color coding
- BulkActionBar conditional rendering: Show only when selectedUserIds.length > 0, hide otherwise
- DataTable pagination: onPageChange receives offset, convert to page number with Math.floor(offset / pageSize) + 1
- Frontend directory: All frontend work in /Users/manav/Space/code/vettr-ops-dashboard/, commits made there
- Users page is already registered in router.tsx from OPS-024, so no router changes needed
---
## OPS-036: User detail page
Status: COMPLETE
Date: 2026-02-08
Working Directory: /Users/manav/Space/code/vettr-ops-dashboard
Details:
- Created complete User detail page implementation in src/pages/UserDetail.tsx
- Implemented user profile fetching using useQuery with GET /v1/admin/users/:id endpoint
- Displayed user profile info card with email, displayName, avatarUrl (with fallback avatar icon), tier (as Badge), authProvider, createdAt, updatedAt
- Implemented Change Tier section with three buttons (Free, Pro, Premium) using useMutation
- Tier change calls POST /v1/admin/users/:id/change-tier endpoint and shows toast notification on success
- Tier buttons are disabled when user already has that tier or during mutation (isPending state)
- Added three related data sections using separate useQuery calls with filter_userId:
  - Watchlist Items: shows stockId (truncated) and addedAt columns
  - Alert Rules: shows stockTicker, ruleType, isActive (Badge), frequency, lastTriggeredAt columns
  - Sync History: shows status (Badge), itemsSynced, startedAt, completedAt, errors columns
- Each related data section uses DataTable component for consistent display
- Implemented loading skeleton state with animate-pulse during initial user data fetch
- Implemented error state with red banner and "User not found" message when user doesn't exist or 404 returned
- Added "Back to Users" button in header and error state for navigation
- All sections show loading skeletons while data loads, empty state messages when no data
- Helper functions: formatDate() for date formatting, truncateUuid() for UUID truncation, getTierVariant() and getStatusVariant() for Badge color mapping
- TypeScript interfaces defined for User, WatchlistItem, AlertRule, SyncHistory, ApiResponse, PaginatedResponse
- Used React Router useParams() to extract user ID from URL, useNavigate() for navigation
- Route already registered as /users/:id in router.tsx from OPS-024
- npm run build passes with no TypeScript errors
Files changed:
- src/pages/UserDetail.tsx (modified - complete implementation)

**Learnings for future iterations:**
- useQuery enabled option: Use enabled: !!id to prevent query execution when id is undefined
- Multiple useQuery calls: Can run multiple independent queries in parallel, each with unique queryKey
- apiGet with params object: Pass query params as second argument to apiGet (e.g., { filter_userId: id })
- PaginatedResponse extraction: API returns { success, data: { items, pagination }, meta }, extract items with response?.data.items || []
- useMutation isPending: Use isPending property (not isLoading) to check mutation status in TanStack Query v5
- Disabled button styling: Use conditional className with ternary operator for dynamic disabled styling based on current state
- Avatar fallback pattern: Use user icon SVG in gray circle when avatarUrl is null
- Related data sections: Fetch with separate queries, display in DataTable with subset of columns relevant for detail view
- Empty state messages: Show user-friendly messages when related data arrays are empty
- DataTable in detail views: Pass no-op callbacks (() => {}) for actions not needed in read-only sections
- Frontend directory: User detail page is frontend work, committed in /Users/manav/Space/code/vettr-ops-dashboard/
- The /users/:id route was already registered in router.tsx from OPS-024, so no router changes needed
- Working with nested API response shapes: Use optional chaining (response?.data) to safely access nested properties
---
## OPS-037: Stocks table page with full CRUD
Status: COMPLETE
Date: 2026-02-08
Working Directory: /Users/manav/Space/code/vettr-ops-dashboard
Details:
- Created complete Stocks page implementation in src/pages/Stocks.tsx replacing placeholder
- Integrated useTable<Stock> hook with endpoint 'stocks' and queryKey 'admin-stocks' for data fetching and CRUD operations
- Implemented SearchInput component for searching by ticker and name (debounced)
- Implemented FilterBar with two filters: exchange (NYSE/NASDAQ/AMEX) and sector (Technology/Healthcare/Finance/Energy/Consumer)
- Implemented ExportButton with useExport hook for CSV/JSON exports
- Created DataTable with 8 columns: ticker, name, exchange, sector, marketCap (formatted with M/B suffix), price (formatted as currency), priceChange (formatted as percentage with green/red color), vetrScore (Badge with color variants), and actions column with Recalculate Score button
- All columns except actions are sortable (ticker, name, exchange, sector, marketCap, price, priceChange, vetrScore)
- Implemented Create Stock modal with form validation (all fields required, number parsing for numeric fields)
- Implemented Edit Stock modal with same form fields, pre-populated with stock data
- Form fields include: ticker, name, exchange, sector, marketCap (number), price (number), priceChange (number), vetrScore (number)
- Implemented delete confirmation using ConfirmDialog with danger variant
- Implemented row selection with BulkActionBar showing count and bulk delete action
- Added Recalculate Score button per row that calls POST /v1/admin/stocks/:ticker/recalculate-score endpoint
- Recalculate Score button shows loading state ("Recalculating...") during API call and is disabled while recalculating
- On successful recalculation, shows toast notification and refetches table data
- All CRUD operations use mutations from useTable hook with proper error/success handling
- Success toast notifications shown after create/update/delete operations
- Error handling delegated to useTable hook mutations which show error toasts automatically
- Implemented helper functions: formatMarketCap() (formats with B/M suffixes), formatCurrency() (formats as $X.XX), formatPercentage() (formats with +/- sign and %), getScoreBadgeVariant() (maps score to Badge color: red <40, yellow 40-70, green >70)
- Fixed TypeScript error: removed unused response variable declaration
- Route already registered as /stocks in router.tsx from OPS-024
- npm run build passes with no TypeScript errors
Files changed:
- src/pages/Stocks.tsx (modified - complete CRUD implementation)

**Learnings for future iterations:**
- Number input parsing pattern: Store as strings in formData, parse with parseFloat() and parseInt() before sending to API
- Market cap formatting: Use 1e9 and 1e6 for billions and millions checks, toFixed(1) for one decimal place
- Percentage formatting: Add + sign for positive values, - sign is automatic for negative values
- Badge variant logic: Extract into getScoreBadgeVariant() helper for reusability across components
- Recalculate Score pattern: Call specialized admin action endpoint POST /v1/admin/stocks/:ticker/recalculate-score, use per-row loading state (isRecalculating === ticker) to disable only the specific button being clicked
- Actions column in DataTable: Use render function with custom button element, pass row data to onClick handler
- apiPost return type: Can be ignored if response data not needed, just await the promise for success/error handling
- Frontend working directory: All frontend commits in /Users/manav/Space/code/vettr-ops-dashboard/
- The /stocks route was already registered in router.tsx from OPS-024, so no router changes needed
- DataTable onSort callback: Pass empty arrow function (() => {}) when sorting not implemented yet
- Price change color coding: Use conditional className with ternary operator for green (positive) or red (negative) text
---
## OPS-038: Executives table page with full CRUD
Status: COMPLETE
Date: 2026-02-08
Working Directory: /Users/manav/Space/code/vettr-ops-dashboard
Details:
- Created complete Executives page implementation in src/pages/Executives.tsx replacing placeholder
- Integrated useTable<Executive> hook with endpoint 'executives' and queryKey 'admin-executives' for data fetching and CRUD operations
- Implemented SearchInput component for searching by name, title, and specialization (debounced)
- Implemented FilterBar with stockId filter (text input for UUID filtering)
- Implemented ExportButton with useExport hook for CSV/JSON exports
- Created DataTable with 7 columns: name, title, yearsAtCompany (formatted to 1 decimal place), specialization (with N/A fallback), education (with N/A fallback), stockId (truncated to 8 chars), createdAt (formatted date)
- All columns except specialization, education, and stockId are sortable
- Implemented Create Executive modal with comprehensive form validation (name, title, stockId, yearsAtCompany required)
- Implemented Edit Executive modal with same form fields, pre-populated with executive data
- Form fields include: name, title, stockId, yearsAtCompany (number), education, specialization, socialLinkedin, socialTwitter, previousCompanies (comma-separated text input)
- previousCompanies field splits comma-separated string into array on save, joins array back to comma-separated string on edit
- Implemented delete confirmation using ConfirmDialog with danger variant
- Implemented row selection with BulkActionBar showing count and bulk delete action
- All CRUD operations use mutations from useTable hook with proper error/success handling
- Success toast notifications shown after create/update/delete operations (handled by useTable hook)
- Error handling delegated to useTable hook mutations which show error toasts automatically
- Implemented helper functions: truncateUuid() (first 8 chars + '...'), formatDate() (formatted as 'MMM DD, YYYY')
- Route already registered as /executives in router.tsx from OPS-024
- npm run build passes with no TypeScript errors
Files changed:
- src/pages/Executives.tsx (modified - complete CRUD implementation)

**Learnings for future iterations:**
- previousCompanies JSONB array field pattern: Store as comma-separated string in form state, split by comma on save (formData.previousCompanies.split(',').map(c => c.trim()).filter(Boolean)), join with ', ' on edit (executive.previousCompanies.join(', '))
- Null handling for optional fields: Use || null pattern to convert empty strings to null for database (formData.education || null)
- Nullable field rendering: Use render function with value || 'N/A' pattern to display fallback text for null fields
- yearsAtCompany formatting: Use value.toFixed(1) to display with 1 decimal place as specified in acceptance criteria
- Executive interface includes nullable fields: education, specialization, socialLinkedin, socialTwitter, previousCompanies (string[] | null)
- FilterBar with stockId: While empty options array is provided, filter still works with text input for UUID filtering via backend filter_stockId param
- Frontend working directory: All frontend commits in /Users/manav/Space/code/vettr-ops-dashboard/
- The /executives route was already registered in router.tsx from OPS-024, so no router changes needed
- Consistent pattern with Users and Stocks pages: Same component structure, state management, and CRUD flow
---

## OPS-039: Filings table page with full CRUD
Status: COMPLETE
Date: 2026-02-08
Working Directory: /Users/manav/Space/code/vettr-ops-dashboard
Details:
- Created complete Filings.tsx page with full CRUD functionality
- Implemented useTable hook with endpoint 'filings' and queryKey 'admin-filings'
- Added SearchInput for searching by title and summary
- Implemented FilterBar with type filter (10-K, 10-Q, 8-K, Press Release, Proxy Statement, S-1), isMaterial filter (true/false), and stockId filter
- Configured DataTable with columns: title (truncated to 60 chars), type, stockId (truncated UUID), date (formatted), isMaterial (Badge with green for Material, info for Non-material), sourceUrl (clickable link or '-'), createdAt (formatted)
- Created Create/Edit modals with FormField inputs for: stockId, type (select dropdown), title, date (date input), summary (textarea), isMaterial (checkbox), sourceUrl
- Implemented delete action with ConfirmDialog and danger variant
- Added BulkActionBar for bulk delete with selectedFilingIds state
- Route /filings already registered in router.tsx from OPS-024
- npm run build passes successfully (build completed in 1.59s)
Files changed:
- src/pages/Filings.tsx (complete implementation)

**Learnings for future iterations:**
- Date inputs need to be converted from ISO format to YYYY-MM-DD format for HTML date inputs (use .split('T')[0])
- Checkbox inputs should have unique IDs when used in multiple modals (e.g., 'isMaterial' and 'isMaterialEdit')
- Filter options can include a placeholder "All Stocks" even for text-based filters like stockId
- Textarea fields don't need FormField wrapper - can be implemented inline with proper styling
- Badge variants: 'success' for positive states (Material), 'info' for neutral states (Non-material)
- ExternalPencil link rendering pattern: check for value existence, then render <a> with target="_blank" rel="noopener noreferrer"
---

## OPS-040: Alert rules table page with full CRUD
Status: COMPLETE
Date: 2026-02-08
Working Directory: /Users/manav/Space/code/vettr-ops-dashboard
Details:
- Created full-featured AlertRules.tsx page with comprehensive CRUD functionality
- Implemented useTable hook integration for alert-rules endpoint
- Added SearchInput for searching by stock ticker and rule type
- Implemented FilterBar with filters for userId, ruleType, isActive, and frequency
- Added ExportButton for CSV/JSON export functionality
- Created DataTable with 8 columns: stockTicker, ruleType, conditionOperator, frequency, threshold, isActive (rendered as Badge), lastTriggeredAt (formatted or 'Never'), createdAt
- Built Create/Edit modals with comprehensive form fields:
  - userId (text input)
  - stockTicker (text input)
  - ruleType (text input)
  - triggerConditions (JSON textarea with validation)
  - conditionOperator (select: AND/OR)
  - frequency (select: realtime/hourly/daily/weekly)
  - threshold (number input, optional)
  - isActive (checkbox)
- Added JSON validation for triggerConditions field with error display
- Implemented delete action with ConfirmDialog (danger variant)
- Route already registered at /alert-rules in router.tsx
- Build passes successfully
Files changed:
- src/pages/AlertRules.tsx (updated from placeholder to full implementation)

**Learnings for future iterations:**
- JSON validation in forms: Wrap JSON.parse in try-catch and set error state for invalid JSON
- Optional numeric fields: Use empty string in form state, convert to number or null when submitting
- Badge variants for status: 'success' for active/enabled states, 'info' for inactive/disabled
- Textarea styling: Use font-mono and text-sm classes for JSON editing
- Form validation: Validate before submit, show inline errors per field
- The route was already registered from OPS-024, so no router changes needed
---

## OPS-041: Alerts table page with full CRUD
Status: COMPLETE
Date: 2026-02-08
Working Directory: /Users/manav/Space/code/vettr-ops-dashboard
Details:
- Created complete Alerts page implementation in src/pages/Alerts.tsx replacing placeholder
- Integrated useTable<Alert> hook with endpoint 'alerts' and queryKey 'admin-alerts' for data fetching and CRUD operations
- Implemented SearchInput component for searching by title and message (debounced)
- Implemented FilterBar with multiple filters: alertType (price_change, filing, red_flag, executive_change), isRead (true/false), userId, stockId
- Implemented ExportButton with useExport hook for CSV/JSON exports
- Created DataTable with 7 columns: title, alertType (as Badge with info variant), stockId (truncated UUID), userId (truncated UUID), message (truncated to 80 chars), triggeredAt (formatted date with time), isRead (Badge: success for Read, warning for Unread)
- All columns except stockId, userId, and message are sortable
- Implemented Create Alert modal with comprehensive form validation (userId, stockId, alertType, title, message required)
- Implemented Edit Alert modal with same form fields, pre-populated with alert data
- Form fields include: userId (text UUID), stockId (text UUID), alertRuleId (optional UUID), alertType (select dropdown), title (text), message (textarea), isRead (checkbox)
- alertRuleId field allows empty string which converts to null on submit for optional foreign key
- Implemented delete confirmation using ConfirmDialog with danger variant (removed title prop as it's not supported)
- Implemented row selection with BulkActionBar showing count and bulk delete action
- All CRUD operations use mutations from useTable hook with proper error/success handling
- Success toast notifications shown after create/update/delete operations (handled by useTable hook)
- Error handling delegated to useTable hook mutations which show error toasts automatically
- Implemented helper functions: truncateUuid() (first 8 chars + '...'), formatDate() (formatted as 'MMM DD, YYYY HH:MM AM/PM'), truncateText() (truncates to specified length)
- Route already registered as /alerts in router.tsx from OPS-024
- npm run build passes with no TypeScript errors after fixing data access pattern
Files changed:
- src/pages/Alerts.tsx (modified - complete CRUD implementation)

**Learnings for future iterations:**
- useTable hook returns data as T[] directly (renamed from items), not as ApiResponse<T>, so access with data || [] not data?.data.items
- ConfirmDialog component doesn't have a title prop - it passes "Confirm Action" as hardcoded title to Modal
- DataTable onDelete expects full row object Alert, not just the ID string
- Badge variants: 'success' for positive states (Read), 'warning' for attention states (Unread), 'info' for neutral/category states (alertType)
- Optional foreign keys: Store empty string in form state, convert to null on submit (alertRuleId || null)
- Checkbox IDs must be unique across Create and Edit modals (isRead vs isReadEdit)
- Consistent pattern with previous table pages: useTable, useExport, SearchInput, FilterBar, ExportButton, BulkActionBar, DataTable, Modal, FormField, ConfirmDialog
- Frontend working directory: All frontend commits in /Users/manav/Space/code/vettr-ops-dashboard/
- The /alerts route was already registered in router.tsx from OPS-024, so no router changes needed
---

## OPS-042: Watchlist items table page
Status: COMPLETE
Date: 2026-02-08
Working Directory: /Users/manav/Space/code/vettr-ops-dashboard
Details:
- Created complete WatchlistItems.tsx page for managing watchlist items (composite-PK table)
- Used useQuery and useMutation directly from TanStack Query instead of the generic useTable hook since this table has a composite primary key (userId, stockId) instead of a single id field
- Implemented FilterBar with userId and stockId filters
- Implemented DataTable with columns: userId (truncated UUID), stockId (truncated UUID), addedAt (formatted date)
- Created Add Watchlist Item modal with FormField inputs for userId and stockId
- Implemented POST /admin/watchlist-items for creating new associations
- Implemented DELETE /admin/watchlist-items with composite key {userId, stockId} body for deletion
- Delete action shows ConfirmDialog with danger variant before deletion
- Pagination controls implemented with page state and offset calculation
- Route was already registered at /watchlist-items in router.tsx
- npm run build passes with no errors
Files changed:
- src/pages/WatchlistItems.tsx (modified - replaced placeholder with full implementation)

**Learnings for future iterations:**
- Composite-PK tables (watchlistItems, filingReads, redFlagAcknowledgments) cannot use the generic useTable hook which expects an id field
- Instead use useQuery directly with custom queryFn and useMutation for create/delete operations
- apiDelete accepts a data parameter which becomes the request body for composite key deletion
- For composite-PK tables: no edit action (nothing to edit), no bulk operations (would need array of composite keys)
- Filter options can have placeholder entries with empty options array if the actual values need to be fetched from the API
- DataTable accepts empty function callbacks (e.g., onEdit={() => {}}) for disabled features
---

## OPS-043: VETR scores table page
Status: COMPLETE
Date: 2026-02-08
Working Directory: /Users/manav/Space/code/vettr-ops-dashboard
Details:
- Created full CRUD implementation for VETR score history table page
- Integrated useTable hook with endpoint 'vetr-score-history' and queryKey 'admin-vetr-scores'
- Implemented SearchInput for searching by stock ticker
- Implemented FilterBar with stockTicker filter (though empty options since it's typically a text input)
- Implemented ExportButton with CSV/JSON export functionality via useExport hook
- Implemented DataTable with 10 columns: stockTicker (monospace font), overallScore (Badge with color based on score: red <40, yellow 40-70, green >70), pedigreeScore, filingVelocityScore, redFlagScore, growthScore, governanceScore (all formatted to 1 decimal), bonusPoints (green with + prefix), penaltyPoints (red with - prefix), calculatedAt (formatted with toLocaleString)
- Implemented Create/Edit modal with FormField inputs for all 9 score fields (stockTicker as text, all others as number type)
- Implemented delete action with ConfirmDialog in danger variant
- All CRUD operations show toast notifications on success/error
- Route was already registered at /vetr-scores in router.tsx
- npm run build passes successfully in vettr-ops-dashboard directory
Files changed:
- src/pages/VetrScores.tsx (modified from placeholder to full implementation)

**Learnings for future iterations:**
- Component interfaces: SearchInput doesn't take a value prop (manages its own state internally), FilterBar takes onFilterChange instead of onChange and value, FormField doesn't support step or required props, ConfirmDialog doesn't have a title prop
- Badge variant mapping for scores: 'error' for <40, 'warning' for 40-70, 'success' for >70
- Form data pattern: Keep form state as strings, convert to numbers with parseFloat when submitting
- Grid layout pattern: Use grid-cols-2 for dual-column form inputs to save vertical space
- Formatting patterns: toFixed(1) for score decimals, toLocaleString() for dates, color coding for bonus/penalty points
---

## OPS-044: Red flags table page
Status: COMPLETE
Date: 2026-02-08
Working Directory: /Users/manav/Space/code/vettr-ops-dashboard
Details:
- Created full RedFlags.tsx page component with complete CRUD functionality
- Implemented useTable hook integration with endpoint 'red-flag-history' and queryKey 'admin-red-flags'
- Added SearchInput for searching stockTicker and description fields
- Added FilterBar with severity filter (Low, Moderate, High, Critical), flagType filter, and stockTicker filter
- Configured DataTable with columns: stockTicker (bold), flagType, severity (Badge with color: info for Low, warning for Moderate, error for High/Critical), score (formatted to 2 decimals), description (truncated to 100 chars), detectedAt (formatted date)
- Created Create/Edit modals with FormField inputs for stockTicker, flagType, severity (select dropdown), score (number input), and description (textarea)
- Implemented delete functionality with ConfirmDialog (danger variant)
- Added export functionality with CSV and JSON format support
- Route was already registered at /red-flags in router.tsx
- npm run build passes successfully
Files changed:
- /Users/manav/Space/code/vettr-ops-dashboard/src/pages/RedFlags.tsx (created full implementation)

**Learnings for future iterations:**
- The RedFlags page follows the same pattern as other table pages (Alerts, VetrScores, etc.)
- Severity badge variant mapping: Low  info, Moderate  warning, High/Critical  error
- The getSeverityVariant helper function handles case-insensitive severity matching
- Score is stored as a number in the interface but needs to be formatted to 2 decimals for display using toFixed(2)
- Form data for score is stored as string for the input, then parsed to float on submit using parseFloat()
- Description is truncated to 100 characters in the table for readability
- The route was already pre-registered in router.tsx, so no router changes were needed
---

## OPS-045: Red flag acknowledgments table page
Status: COMPLETE
Date: 2026-02-08
Working Directory: /Users/manav/Space/code/vettr-ops-dashboard
Details:
- Created RedFlagAcks.tsx page component with full CRUD functionality for composite-PK table
- Implemented custom useQuery hook for fetching data from GET /v1/admin/red-flag-acknowledgments with pagination and filtering
- Added FilterBar with userId and redFlagId filter options
- Implemented DataTable with three columns: userId (truncated UUID), redFlagId (truncated UUID), and acknowledgedAt (formatted date)
- Created Add modal with FormField inputs for userId and redFlagId that POSTs to /v1/admin/red-flag-acknowledgments
- Implemented DELETE action that sends composite key { userId, redFlagId } to DELETE /v1/admin/red-flag-acknowledgments after ConfirmDialog confirmation
- Used useMutation hooks with proper query invalidation for create and delete operations
- Route was already registered at /red-flag-acks in router.tsx
- npm run build passes successfully in vettr-ops-dashboard directory
Files changed:
- src/pages/RedFlagAcks.tsx (modified - changed from placeholder to full implementation)

**Learnings for future iterations:**
- Composite-PK tables (like redFlagAcknowledgments, watchlistItems, filingReads) require custom useQuery instead of the generic useTable hook since they don't have a single 'id' field
- DELETE mutations for composite-PK tables must send the composite key fields { userId, redFlagId } in the request body instead of a single ID in the URL path
- No edit functionality is needed for junction/acknowledgment tables since the composite key fields cannot be changed (would require delete + create instead)
- No bulk operations for composite-PK tables to keep the implementation simple
- The WatchlistItems.tsx component serves as a good pattern reference for all composite-PK table pages
- Helper functions truncateUuid and formatDate are duplicated in multiple pages - could be centralized in src/lib/formatters.ts in future stories
---

## OPS-046: Sync history table page
Status: COMPLETE
Date: 2026-02-08
Working Directory: /Users/manav/Space/code/vettr-ops-dashboard
Details:
- Created full CRUD sync history management page in src/pages/SyncHistory.tsx
- Implemented useTable hook integration with endpoint 'sync-history' and queryKey 'admin-sync-history'
- Added SearchInput component for searching status field
- Added FilterBar with status filter (pending, success, failed) and userId filter
- Rendered DataTable with columns: userId (truncated UUID), status (Badge with color variants), itemsSynced, startedAt, completedAt, errors
- Status badge variants: success=green, pending=yellow, failed=red
- Implemented Create modal with form fields: userId, status (select), itemsSynced (number), errors (textarea)
- Implemented Edit modal with same form fields, pre-populated with existing data
- Added delete action with ConfirmDialog for confirmation
- Integrated ExportButton for CSV/JSON export functionality
- Proper date formatting with formatDate() helper, showing "In Progress" for null completedAt
- Error text displayed in red with truncation to 80 characters
- Route already registered at /sync-history in router.tsx
- npm run build passes successfully in vettr-ops-dashboard directory
Files changed:
- src/pages/SyncHistory.tsx (modified - replaced placeholder with full implementation)

**Learnings for future iterations:**
- Status badge color mapping pattern: use a helper function getStatusBadgeVariant() to map status strings to badge variants
- Date formatting for nullable fields: check for null/undefined and return a fallback string like "In Progress" or "N/A"
- Error display pattern: show errors in red text color using TailwindCSS text-red-600 class
- Form field handling for nullable integers: convert string to parseInt() on submit, handle empty strings as null
- The SyncHistory interface matches the backend schema with nullable fields for itemsSynced, completedAt, and errors
- useTable hook automatically handles pagination, search, filters, and CRUD mutations
- All frontend pages follow the same consistent pattern: SearchInput + FilterBar + ExportButton + DataTable + Modals
---

## OPS-047: User settings table page
Status: COMPLETE
Date: 2026-02-08
Working Directory: /Users/manav/Space/code/vettr-ops-dashboard
Details:
- Created UserSettings.tsx page component with full CRUD functionality
- Implemented useTable hook integration with 'user-settings' endpoint and 'admin-user-settings' queryKey
- Added FilterBar with userId filter and ExportButton for data export
- Configured DataTable with columns: userId (truncated UUID), settings (JSON with View link), updatedAt (formatted date)
- Implemented Create/Edit modals with userId text input and settings JSON textarea
- Added JSON syntax validation that shows error message if invalid JSON is entered
- Validation clears error on keystroke and validates on submit using try/catch with JSON.parse
- Implemented View modal that displays pretty-printed JSON settings with pre tag and max-height scrolling
- Delete functionality with ConfirmDialog confirmation
- Route already registered at /user-settings in router.tsx
- npm run build passes successfully

Files changed:
- src/pages/UserSettings.tsx (updated from placeholder)

**Learnings for future iterations:**
- JSON validation pattern: Use try/catch around JSON.parse in submit handlers, maintain jsonError state
- View modal pattern: Use <pre> tag with pretty-printed JSON (JSON.stringify with null, 2 indent)
- Settings column render: Truncate JSON string to 100 chars with View link that opens modal
- FilterBar can have minimal options (just userId filter with 'All Users' default)
- Helper functions (truncateUuid, formatDate, truncateText) are duplicated across pages - could be centralized in future refactor
---

## OPS-048: Refresh tokens table page
Status: COMPLETE
Date: 2026-02-08
Working Directory: /Users/manav/Space/code/vettr-ops-dashboard
Details:
- Created RefreshTokens.tsx page implementing full CRUD functionality for refresh tokens
- Used useTable hook with endpoint 'refresh-tokens' and queryKey 'admin-refresh-tokens'
- Implemented FilterBar with userId filter and isRevoked filter (Active/Revoked options)
- Created DataTable with columns: userId (truncated), tokenHash (truncated to 20 chars for security), expiresAt (red if past), isRevoked (Badge), createdAt
- Added 'Revoke' quick action button per row that calls updateMutation with isRevoked=true and shows toast notification
- Implemented edit modal with checkbox for toggling isRevoked status
- Added delete functionality with ConfirmDialog confirmation
- Implemented bulk delete support via BulkActionBar and bulkDeleteMutation
- Added export functionality with CSV/JSON support via ExportButton
- Expired tokens are highlighted in red with "(Expired)" label
- Active tokens show green Badge, revoked tokens show red Badge
- Route was already registered in router.tsx at /refresh-tokens
- npm run build passes successfully

Files changed:
- src/pages/RefreshTokens.tsx (completely rewritten from placeholder)

**Learnings for future iterations:**
- Token security: Always truncate sensitive data like tokenHash in the UI for security
- Date comparison: Use isPastDate helper to check if dates are in the past and style accordingly
- Quick actions: Inline action buttons (like Revoke) provide better UX than requiring modal navigation
- Toast notifications: Use toast.success/error for immediate feedback on quick actions
- Conditional rendering: Show quick action buttons only when applicable (e.g., Revoke button only for active tokens)
- Badge variants: error for Revoked (red), success for Active (green)
- Edit modal pattern: For simple toggle fields like isRevoked, a checkbox with explanation text works well
- The useTable hook provides all necessary CRUD mutations out of the box
---

## OPS-049: Filing reads table page
Status: COMPLETE
Date: 2026-02-08
Working Directory: /Users/manav/Space/code/vettr-ops-dashboard
Details:
- Created FilingReads.tsx page with full CRUD functionality for the composite-PK filingReads table
- Implemented data fetching with useQuery from @tanstack/react-query for GET /v1/admin/filing-reads
- Added FilterBar with userId and filingId filter options
- Rendered DataTable with columns: userId (truncated UUID), filingId (truncated UUID), readAt (formatted date)
- Implemented create modal with FormField inputs for userId and filingId that POSTs to /v1/admin/filing-reads
- Implemented delete action with ConfirmDialog that sends DELETE /v1/admin/filing-reads with { userId, filingId } body (composite key)
- Added pagination controls with page and pageSize state management
- Route was already registered in router.tsx at /filing-reads
- npm run build passed successfully in the vettr-ops-dashboard directory
Files changed:
- src/pages/FilingReads.tsx (modified - replaced placeholder with full implementation)

**Learnings for future iterations:**
- Composite-PK tables (filingReads, watchlistItems, redFlagAcknowledgments) follow the same pattern: custom useQuery (not useTable), filters for both key columns, delete sends body with both keys
- The pattern is consistent with WatchlistItems.tsx which was implemented in OPS-042
- For composite-PK tables, there's no edit action (only create and delete), and no bulk operations or row selection
- Helper functions (truncateUuid, formatDate) are defined locally in each page component for now (could be extracted to lib/formatters.ts in a future story)
- The DELETE endpoint for composite-PK tables uses the request body to pass both keys, not URL parameters
---

## OPS-050: Bulk import page with CSV/JSON upload
Status: COMPLETE
Date: 2026-02-08
Working Directory: /Users/manav/Space/code/vettr-ops-dashboard
Details:
- Implemented comprehensive bulk import page with full CSV and JSON support
- Table selector dropdown with all 11 available admin tables
- Drag-and-drop file upload area with visual feedback for drag state
- CSV parser that properly handles quoted values, commas, newlines, and escaped quotes
- JSON parser supporting both array and single object formats
- Preview DataTable showing first 10 rows with auto-generated columns from data keys
- Row count and column count display above preview
- Import button with loading spinner and disabled state during import
- POST request to /admin/{table}/bulk endpoint with parsed records
- Toast notifications for success (showing imported count) and errors
- Automatic state reset after successful import
- Route already registered at /bulk-import in router.tsx
- Build passes with no TypeScript errors

Files changed:
- src/pages/BulkImport.tsx (completely rewritten from placeholder)

**Learnings for future iterations:**
- CSV parsing requires careful handling of quoted fields and escaped quotes
- The parseCSVLine function handles edge cases like quotes within quotes
- File upload with both drag-and-drop and click-to-browse provides good UX
- Preview functionality is essential for bulk operations to verify data before import
- State reset after import prevents accidental re-imports
- The DataTable component works well for previewing arbitrary data structures
---

## OPS-051: Re-seed data action with confirmation
Status: COMPLETE
Date: 2026-02-08
Working Directory: /Users/manav/Space/code/vettr-ops-dashboard
Details:
- Added Quick Actions section to Dashboard.tsx below the Stock Health section
- Created Re-Seed Database button styled as a warning/destructive action (amber background)
- Integrated ConfirmDialog with danger variant asking for confirmation before re-seeding
- Implemented handleReseed async function that calls POST /v1/admin/seed/run
- Added loading state with spinner icon displayed on button during re-seed operation
- Button is disabled while re-seeding to prevent duplicate requests
- Success handler shows toast notification with response message and invalidates all TanStack Query cache to refresh dashboard data
- Error handler shows toast notification with error message from API response
- Properly handles API response shape: { success: boolean, data: { message: string } }
- npm run build passes with no TypeScript errors

Files changed:
- src/pages/Dashboard.tsx (modified - added re-seed functionality)

**Learnings for future iterations:**
- TanStack Query cache invalidation: Use queryClient.invalidateQueries() without arguments to invalidate all queries
- React state management: Use useState for dialog visibility and loading states
- Toast notifications: Import toast from 'react-hot-toast', use toast.success() and toast.error()
- Button disabled state: Use disabled prop with conditional className for visual feedback
- Loading spinners: Use SVG animate-spin class from Tailwind for rotation animation
- API client usage: apiPost<ResponseType>(url) with proper TypeScript typing for responses
- Error handling: Access error.response?.data?.error?.message for API error messages
- The Quick Actions section provides a central location for destructive/admin-only operations
---

## OPS-052: Bulk tier change for selected users
Status: COMPLETE
Date: 2026-02-08
Working Directory: /Users/manav/Space/code/vettr-ops-dashboard
Details:
- Updated BulkActionBar component to support custom action buttons via customActions prop
- Added bulk tier change functionality to Users page including:
  - "Change Tier" button in BulkActionBar when users are selected
  - Modal with tier selector (free/pro/premium) and confirmation message
  - Bulk tier change handler that uses Promise.all for parallel execution
  - Progress indicator showing "Updating X of Y users..." with visual progress bar
  - Success/error handling with appropriate toast notifications
  - Query invalidation to refresh table data after changes
  - Selection clearing after successful operation
- Imported useQueryClient and apiPost in Users.tsx for state management and API calls
- All acceptance criteria met including error handling for failed updates
- npm run build passes successfully
- **Learnings for future iterations:**
  - BulkActionBar component was extended to be more flexible with custom actions
  - React Query's invalidateQueries is used to refresh data after bulk operations
  - Promise.all enables parallel API calls for better performance
  - Progress tracking with setBulkTierProgress provides good UX during long operations
  - Error handling aggregates failures and reports them in toast messages
  - The pattern of adding customActions to BulkActionBar can be reused for other bulk operations on different tables
---


## OPS-053: Date and number formatting utilities
Status: COMPLETE
Date: 2026-02-08
Working Directory: /Users/manav/Space/code/vettr-ops-dashboard
Details:
- Created src/lib/formatters.ts with comprehensive formatting utilities
- Implemented formatDate() - formats ISO date strings as 'Jan 15, 2025 3:45 PM' using Intl.DateTimeFormat
- Implemented formatDateShort() - formats dates as 'Jan 15' for chart axes
- Implemented formatRelativeTime() - returns relative time strings like '2 hours ago', '3 days ago', 'just now'
- Implemented formatNumber() - formats numbers with thousand separators (1,234,567)
- Implemented formatCurrency() - formats as $1,234.56 with 2 decimal places
- Implemented formatMarketCap() - formats large numbers with suffixes ($1.5B, $234.5M, $45.2K)
- Implemented formatPercentage() - formats percentages with sign (+12.5%, -3.2%)
- Implemented getPercentageColorClass() - returns appropriate Tailwind color class (text-green-600 or text-red-600) for percentage values
- Implemented truncateUuid() - returns first 8 characters of UUID followed by '...'
- All functions handle edge cases: null/undefined values, invalid dates, NaN numbers
- npm run build passes with no TypeScript errors

Files changed:
- src/lib/formatters.ts (created)

**Learnings for future iterations:**
- Intl.DateTimeFormat API provides consistent, localized date/time formatting across browsers
- Relative time formatting is useful for recent events (sync history, alerts, etc.)
- Market cap formatting should handle trillions, billions, millions, and thousands with single decimal precision
- Percentage color classes can be used directly in React components for conditional styling
- All formatting functions should gracefully handle null/undefined/invalid inputs by returning empty strings
- Frontend utilities do NOT need .js extensions in imports (Vite handles this automatically, unlike backend ESM)
---

## OPS-054: Client-side CSV generation utility
Status: COMPLETE
Date: 2026-02-08
Working Directory: /Users/manav/Space/code/vettr-ops-dashboard
Details:
- Created src/lib/csv.ts with client-side CSV generation and download utilities
- Implemented generateCsv(data, columns?) function that:
  - Accepts array of objects and optional column filter
  - Generates CSV string with header row from column names
  - Handles all edge cases: null/undefined  empty string, Date  ISO string, arrays/objects  JSON
  - Properly escapes CSV values: wraps in quotes if contains comma/quote/newline, doubles existing quotes
  - Returns just header row for empty arrays when columns are specified
- Implemented downloadCsv(csvContent, filename) function that:
  - Creates Blob with text/csv MIME type
  - Creates temporary anchor element with download attribute
  - Programmatically triggers download
  - Cleans up by removing element and revoking object URL
- Added helper function escapeCsvValue() for proper CSV value escaping
- npm run build passes with no errors
Files changed:
- src/lib/csv.ts (created)

**Learnings for future iterations:**
- CSV escaping rules: wrap in quotes if value contains comma, double quote, newline, or carriage return
- Escape existing double quotes by doubling them (replace " with "")
- Blob API with MIME type text/csv triggers browser download when used with anchor element
- URL.createObjectURL() and URL.revokeObjectURL() pattern for creating temporary download URLs
- TypeScript type coercion: Arrays and objects need JSON.stringify, Dates need .toISOString()
- Empty arrays can still generate header row if columns are explicitly provided
---

## OPS-055: Table column configuration definitions
Status: COMPLETE
Date: 2026-02-08
Working Directory: /Users/manav/Space/code/vettr-ops-dashboard
Details:
- Created src/config/columns.ts with centralized column configuration objects for all 14 database tables
- Exported column configs: userColumns, stockColumns, executiveColumns, filingColumns, alertRuleColumns, alertColumns, watchlistItemColumns, vetrScoreColumns, redFlagColumns, redFlagAckColumns, syncHistoryColumns, userSettingsColumns, refreshTokenColumns, filingReadColumns
- Each column config follows the ColumnConfig<T> interface with key, label, sortable, and optional render function
- Render functions leverage formatting utilities from src/lib/formatters.ts: formatDate for timestamps, truncateUuid for UUIDs, formatCurrency for prices, formatMarketCap for market caps, formatPercentage for changes, formatNumber for counts
- Render functions use Badge component with appropriate variant mapping for status fields (tier: free=info/pro=warning/premium=success, severity: low=info/moderate=warning/high=error, isActive: active=success/inactive=info, isRead: read=success/unread=warning, etc.)
- Used React.createElement (aliased as h) instead of JSX syntax since this is a .ts file (not .tsx)
- All column configs are properly typed with TypeScript generics
- npm run build passes with no TypeScript errors
Files changed:
- src/config/columns.ts (created)

**Learnings for future iterations:**
- .ts files cannot contain JSX syntax - use React.createElement or rename to .tsx
- React.createElement can be aliased as 'h' for cleaner syntax: import { createElement as h } from 'react'
- Badge component from components/ui/Badge.tsx has 4 variants: success (green), warning (yellow), error (red), info (blue)
- Column render functions receive (value, row) but row parameter should be omitted if unused to avoid TypeScript warnings
- Proper score color mapping: <40 = error (red), 40-70 = warning (yellow), >70 = success (green)
- Severity mapping: Low = info, Moderate = warning, High/Critical = error
- Date/time fields should consistently use formatDate for full timestamps
- UUIDs should be truncated with truncateUuid for better table readability
- Market caps use formatMarketCap for B/M/K suffixes
- Prices use formatCurrency for $X.XX formatting
- Percentage changes use formatPercentage and getPercentageColorClass for colored display
- Links should use anchor tags with target="_blank" and rel="noopener noreferrer"
- Truncated text fields should show first N chars + "..." for long strings
---

## OPS-056: Toast notification integration
Status: COMPLETE
Date: 2026-02-08
Working Directory: /Users/manav/Space/code/vettr-ops-dashboard
Details:
- Configured Toaster component in App.tsx with custom styling:
  - Position: top-right
  - Duration: 4000ms
  - Success toast: green background (#10b981)
  - Error toast: dark background (#1f2937)
- Verified toast notifications already implemented in useTable hook:
  - toast.success() for create, update, delete, and bulk delete mutations
  - toast.error() in onError callbacks with API error messages
  - Success messages follow pattern: "Created users successfully", "Deleted 5 users successfully"
- Verified toast notifications in specialized actions:
  - Dashboard.tsx: re-seed database action
  - UserDetail.tsx: tier change action
  - Stocks.tsx: score recalculation action
  - BulkImport.tsx: import operations
  - Users.tsx: bulk tier change action
- npm run build passes in vettr-ops-dashboard directory

Files changed:
- src/App.tsx (modified - configured Toaster with custom styling)

**Learnings for future iterations:**
- react-hot-toast configuration: position, duration, and toastOptions for custom styling
- All CRUD toast notifications were already implemented in previous stories
- Success toasts use green background, error toasts use dark background for visibility
- Toaster component requires custom styling via toastOptions.success.style and toastOptions.error.style
- All specialized actions (tier change, score recalc, seed, bulk import) already had toast notifications from their respective stories
---

## OPS-057: Keyboard shortcuts for common actions
Status: COMPLETE
Date: 2026-02-08
Working Directory: /Users/manav/Space/code/vettr-ops-dashboard
Details:
- Created src/hooks/useKeyboardShortcuts.ts with useKeyboardShortcuts hook
- Implemented support for Ctrl/Cmd+K (focus search), Escape (close modal), Ctrl/Cmd+N (open create modal), and Ctrl/Cmd+E (trigger export dropdown)
- Shortcuts accept callbacks via KeyboardShortcutHandlers interface: focusSearch, closeModal, openCreate, triggerExport
- Shortcuts do not trigger when user is typing in INPUT, TEXTAREA, or SELECT elements (checks event.target.tagName)
- Cross-platform modifier key support: detects Mac platform and uses metaKey for Cmd, otherwise uses ctrlKey for Ctrl
- Integrated hook in Layout.tsx for global Escape shortcut to close mobile sidebar when it's open
- Event listeners are properly cleaned up on component unmount via useEffect return
- npm run build passes in the vettr-ops-dashboard directory
Files changed:
- src/hooks/useKeyboardShortcuts.ts (created)
- src/components/Layout.tsx (modified - added useKeyboardShortcuts import and usage for Escape to close sidebar)

**Learnings for future iterations:**
- React keyboard event handling: Use window.addEventListener in useEffect for global shortcuts, not component-level onKeyDown
- Platform detection: navigator.platform.toUpperCase().indexOf('MAC') >= 0 detects macOS
- Event target checking: Cast event.target as HTMLElement to access tagName property
- Callback pattern: Optional callbacks (focusSearch?, closeModal?, etc.) allow components to selectively implement shortcuts
- Effect cleanup: Always return cleanup function from useEffect to remove event listeners
- Table pages can integrate this hook for page-specific shortcuts (Ctrl+N to open create modal, Ctrl+E for export, Ctrl+K for search)
- The hook is designed to be flexible - components pass only the handlers they need
---

## OPS-058: Responsive design for mobile and tablet
Status: COMPLETE
Date: 2026-02-08
Working Directory: /Users/manav/Space/code/vettr-ops-dashboard
Details:
- Updated Dashboard.tsx StatCards grid: 1 col mobile, 2 cols tablet (sm), 3 cols desktop (lg), 4 cols xl
- Updated chart layouts: two-column sections now use md:grid-cols-2 to stack on mobile
- Updated DataTable pagination: flex-col on mobile with full-width buttons, flex-row on sm+
- Updated FilterBar: stack filters vertically on mobile with full-width inputs, horizontal on sm+
- Updated Modal: full width on mobile (max-w-full), constrained to max-w-lg on sm+
- Updated all interactive elements to meet 44x44px minimum touch target size
- Updated SearchInput: 44px height input, proper touch target for clear button
- Updated ExportButton: 44px height for main button and dropdown menu items
- Updated BulkActionBar: responsive flex layout, stacks on mobile
- Layout.tsx already had collapsible sidebar with hamburger menu for mobile
- DataTable already had overflow-x-auto wrapper for horizontal scrolling
- All charts already wrapped in ResponsiveContainer from Recharts
- npm run build passes successfully
Files changed:
- src/pages/Dashboard.tsx (modified - responsive grid breakpoints)
- src/components/DataTable.tsx (modified - responsive pagination and touch targets)
- src/components/FilterBar.tsx (modified - responsive stacking)
- src/components/ui/Modal.tsx (modified - responsive width)
- src/components/SearchInput.tsx (modified - touch target sizes)
- src/components/ExportButton.tsx (modified - touch target sizes)
- src/components/BulkActionBar.tsx (modified - responsive layout)

**Learnings for future iterations:**
- TailwindCSS responsive breakpoints: sm (640px), md (768px), lg (1024px), xl (1280px)
- Mobile-first approach: default styles are for mobile, add responsive classes with breakpoint prefixes
- Touch target sizes: min-h-[44px] and min-w-[44px] ensure WCAG compliance on mobile
- Responsive flex patterns: flex-col on mobile, sm:flex-row on larger screens
- Grid responsive patterns: grid-cols-1 md:grid-cols-2 lg:grid-cols-3 for progressive enhancement
- Full-width modals on mobile: max-w-full with sm:max-w-lg allows modals to use full screen on small devices
- Gap spacing: use smaller gaps on mobile (gap-3 or gap-4) and larger on desktop (sm:gap-6) for better mobile UX
- Buttons on mobile: flex-1 sm:flex-none makes buttons full-width on mobile, auto-width on larger screens
- The sidebar collapse functionality was already implemented in Layout.tsx from OPS-023
- DataTable overflow-x-auto was already present, ensuring horizontal scroll on mobile
---

## OPS-059: Loading states and error boundaries
Status: COMPLETE
Date: 2026-02-08
Working Directory: /Users/manav/Space/code/vettr-ops-dashboard/
Details:
- Created src/components/LoadingSpinner.tsx with centered spinning animation and size prop (sm, md, lg)
- Created src/components/ErrorBoundary.tsx React error boundary class component that catches render errors and displays fallback UI with error message and Retry button that resets error state
- Created src/components/PageSkeleton.tsx full-page loading skeleton with animated gray bars mimicking table page layout (search bar, filter bar, table rows)
- Wrapped all route page components in ErrorBoundary in src/router.tsx (Dashboard, Users, UserDetail, Stocks, Executives, Filings, AlertRules, Alerts, WatchlistItems, VetrScores, RedFlags, RedFlagAcks, SyncHistory, UserSettings, RefreshTokens, FilingReads, BulkImport)
- Layout component is NOT wrapped in ErrorBoundary so sidebar remains visible even if page content errors
- Updated Dashboard.tsx to show PageSkeleton for initial loading, added error state with Retry button that calls refetch()
- Updated all table pages (Users, Stocks, Executives, Filings, AlertRules, Alerts, VetrScores, RedFlags, SyncHistory, UserSettings, RefreshTokens) to add error and refetch from useTable hook, show PageSkeleton when isLoading=true, and show centered error message with Retry button on error
- Updated composite-PK table pages (WatchlistItems, FilingReads, RedFlagAcks) which use useQuery instead of useTable to extract error and refetch from the hook
- Updated UserDetail.tsx to replace custom loading skeleton with PageSkeleton and add error state with Retry button
- BulkImport.tsx skipped as it doesn't fetch data on mount (no loading state needed)
- npm run build passes with no errors in vettr-ops-dashboard directory
Files changed:
- src/components/LoadingSpinner.tsx (created)
- src/components/ErrorBoundary.tsx (created)
- src/components/PageSkeleton.tsx (created)
- src/router.tsx (modified - wrapped all page routes in ErrorBoundary)
- src/pages/Dashboard.tsx (modified - added PageSkeleton and error state with Retry)
- src/pages/Users.tsx (modified - added PageSkeleton, error, refetch, and error state with Retry)
- src/pages/Stocks.tsx (modified - added PageSkeleton, error, refetch, and error state with Retry)
- src/pages/Executives.tsx (modified - added PageSkeleton, error, refetch, and error state with Retry)
- src/pages/Filings.tsx (modified - added PageSkeleton, error, refetch, and error state with Retry)
- src/pages/AlertRules.tsx (modified - added PageSkeleton, error, refetch, and error state with Retry)
- src/pages/Alerts.tsx (modified - added PageSkeleton, error, refetch, and error state with Retry)
- src/pages/VetrScores.tsx (modified - added PageSkeleton, error, refetch, and error state with Retry)
- src/pages/RedFlags.tsx (modified - added PageSkeleton, error, refetch, and error state with Retry)
- src/pages/SyncHistory.tsx (modified - added PageSkeleton, error, refetch, and error state with Retry)
- src/pages/UserSettings.tsx (modified - added PageSkeleton, error, refetch, and error state with Retry)
- src/pages/RefreshTokens.tsx (modified - added PageSkeleton, error, refetch, and error state with Retry)
- src/pages/WatchlistItems.tsx (modified - added PageSkeleton, error, refetch, and error state with Retry)
- src/pages/FilingReads.tsx (modified - added PageSkeleton, error, refetch, and error state with Retry)
- src/pages/RedFlagAcks.tsx (modified - added PageSkeleton, error, refetch, and error state with Retry)
- src/pages/UserDetail.tsx (modified - replaced custom loading skeleton with PageSkeleton, added error state with Retry)

**Learnings for future iterations:**
- React ErrorBoundary pattern: Use class component with getDerivedStateFromError and componentDidCatch lifecycle methods to catch render errors
- ErrorBoundary only catches errors in child component tree during render, not in event handlers or async code
- TanStack Query useQuery and custom useTable hook both return error and refetch for error handling
- Consistent error UX: centered error icon SVG, error message from API response or fallback message, blue Retry button
- PageSkeleton mimics the actual page layout (search, filters, table) for better perceived performance
- LoadingSpinner with size variants (sm/md/lg) is reusable for inline loading states (though not heavily used in this story)
- ErrorBoundary should wrap page content but NOT the Layout component so navigation remains accessible during errors
- Each page should extract error and refetch from data-fetching hooks and show PageSkeleton when isLoading=true before the main return statement
- Error state should show friendly message, error details from API if available, and a Retry button that calls refetch()
---

## OPS-060: URL synchronization for table state
Status: COMPLETE
Date: 2026-02-08
Working Directory: /Users/manav/Space/code/vettr-ops-dashboard
Details:
- Created src/hooks/useUrlState.ts hook that synchronizes table state with URL query parameters
- Implemented useSearchParams from React Router (v7) to read and update URL params
- Hook returns parsed state (page, pageSize, search, sort, filters) from URL query params
- Created update functions: updatePage, updatePageSize, updateSearch, updateSort, updateFilters
- URL params are kept clean by omitting default values (page=1, pageSize=25) and empty strings
- When search, sort, or filters change, page is automatically reset to 1
- Used replace: true in setSearchParams to avoid cluttering browser history
- Integrated useUrlState into useTable hook by replacing useState with URL state management
- All table pages now automatically sync their state to URL without code changes
- Browser back/forward navigation correctly restores previous table state
- Shareable links preserve exact table view with all filters, sorting, and pagination
- Fixed TypeScript errors by adding explicit types to forEach callbacks
- npm run build passes successfully
Files changed:
- src/hooks/useUrlState.ts (created)
- src/hooks/useTable.ts (modified - replaced useState with useUrlState)

**Learnings for future iterations:**
- React Router v7 exports useSearchParams directly from 'react-router' package
- URLSearchParams.forEach callbacks need explicit types in TypeScript: (value: string, key: string) => void
- setSearchParams accepts a callback function: (prev: URLSearchParams) => URLSearchParams
- Using replace: true in setSearchParams prevents cluttering browser history during rapid state updates
- URL state pattern: parse on mount from searchParams, update via setSearchParams, react to changes via useMemo
- Filter params follow filter_* naming convention and must be parsed/serialized correctly
- Reset to page 1 when search/sort/filters change to avoid showing empty pages after filtering
- Omit default values from URL to keep URLs clean and shareable
---

## OPS-061: Backend integration tests for admin CRUD endpoints
Status: COMPLETE
Date: 2026-02-08
Working Directory: /Users/manav/Space/code/vettr-backend
Details:
- Created tests/admin-crud.test.ts with comprehensive integration tests for admin CRUD endpoints
- Implemented tests for GET /v1/admin/users with pagination, search, sort, and filter functionality
- Tested paginated response shape with success, data.items, data.pagination, and meta fields
- Verified search parameter filters results across email and displayName columns
- Verified sort parameter (createdAt:desc) orders results correctly
- Verified filter_tier parameter filters users by tier
- Tested GET /v1/admin/users/:id returns 200 for existing records and 404 for non-existent IDs
- Tested POST /v1/admin/users creates records and returns 201 status
- Tested PUT /v1/admin/users/:id updates records and returns 200 status
- Tested DELETE /v1/admin/users/:id deletes records and returns 200, or 404 for non-existent IDs
- Tested authentication: all endpoints return 401 without X-Admin-Secret header
- Tested invalid admin secret returns 401 with AUTH_REQUIRED error code
- Used vitest mocking to mock the AdminCrudService for isolated testing
- All tests follow the existing integration test patterns from tests/integration/stocks.test.ts
- npm run build and npm run typecheck both pass with no errors
Files changed:
- tests/admin-crud.test.ts (created)

**Learnings for future iterations:**
- Integration test pattern: Import app from '../src/app.js' and use app.request() to make HTTP requests
- Mock services using vi.mock() with partial mocking via vi.importActual() to preserve non-mocked exports
- Admin endpoints require X-Admin-Secret header (set via process.env.ADMIN_SECRET in tests)
- Response shape verification: Check success, data, pagination (for list endpoints), and meta fields
- Error testing: Use NotFoundError from utils/errors.js and verify error.code in response
- Status codes: 200 for successful GET/PUT/DELETE, 201 for POST, 404 for not found, 401 for auth errors
- The AdminCrudService is instantiated by the route factory, so we mock the class constructor
- Test coverage should include: happy path, filtering/search/sort, error cases (404), and authentication
---

## OPS-062: Backend integration tests for analytics endpoints
Status: COMPLETE
Date: 2026-02-08
Working Directory: /Users/manav/Space/code/vettr-backend
Details:
- Created tests/admin-analytics.test.ts with comprehensive integration tests for all analytics endpoints
- Tested GET /v1/admin/analytics/user-growth - returns array of { date, count } objects for 90 days
- Tested GET /v1/admin/analytics/score-distribution - returns array of { range, count } with score buckets
- Tested GET /v1/admin/analytics/red-flag-trends - returns array of { date, severity, count } for 30 days
- Tested GET /v1/admin/analytics/filing-activity - returns array of { date, count } for 30 days
- Tested GET /v1/admin/analytics/alert-activity - returns array of { date, count } for 30 days
- Tested GET /v1/admin/analytics/tier-breakdown - returns array of { tier, count } for user tiers
- Tested GET /v1/admin/analytics/stock-health - returns { lowest_scores: Array, most_flags: Array }
- All endpoints verify 200 status, correct response shape, and proper data structure
- All endpoints verify 401 authentication requirement without X-Admin-Secret header
- Used vitest with mocked database execute function for consistent test behavior
- npm run build and npm run typecheck both pass
Files changed:
- tests/admin-analytics.test.ts (created)

**Learnings for future iterations:**
- Analytics endpoints use db.execute() with raw SQL queries for aggregations
- Mock db.execute() returns { rows: Array } shape for SQL query results
- Multiple db.execute() calls in one endpoint (like stock-health) need mockResolvedValueOnce chaining
- Standard API response shape: { success: true, data: { data: Array }, meta: { timestamp, request_id } }
- All analytics endpoints are protected by adminAuthMiddleware and require X-Admin-Secret header
- Test structure mirrors admin-crud.test.ts with describe blocks per endpoint and auth tests
---
